using System;
using System.ServiceProcess;
using System.Threading.Tasks;
using System.Collections.Generic;

namespace AdvancedRAT.Client.Handlers
{
    public class ServiceHandler
    {
        public async Task<object> GetServiceList()
        {
            try
            {
                var services = new List<object>();
                
                foreach (var service in ServiceController.GetServices())
                {
                    try
                    {
                        services.Add(new
                        {
                            name = service.ServiceName,
                            displayName = service.DisplayName,
                            status = service.Status.ToString(),
                            startType = service.StartType.ToString()
                        });
                    }
                    catch { }
                }
                
                return new { success = true, services };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> StartService(string name)
        {
            try
            {
                var service = new ServiceController(name);
                
                if (service.Status != ServiceControllerStatus.Running)
                {
                    service.Start();
                    service.WaitForStatus(ServiceControllerStatus.Running, TimeSpan.FromSeconds(30));
                    return new { success = true, message = $"Service {name} started" };
                }
                
                return new { success = false, message = "Service already running" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> StopService(string name)
        {
            try
            {
                var service = new ServiceController(name);
                
                if (service.Status != ServiceControllerStatus.Stopped)
                {
                    service.Stop();
                    service.WaitForStatus(ServiceControllerStatus.Stopped, TimeSpan.FromSeconds(30));
                    return new { success = true, message = $"Service {name} stopped" };
                }
                
                return new { success = false, message = "Service already stopped" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> RestartService(string name)
        {
            try
            {
                var service = new ServiceController(name);
                
                if (service.Status == ServiceControllerStatus.Running)
                {
                    service.Stop();
                    service.WaitForStatus(ServiceControllerStatus.Stopped, TimeSpan.FromSeconds(30));
                }
                
                service.Start();
                service.WaitForStatus(ServiceControllerStatus.Running, TimeSpan.FromSeconds(30));
                
                return new { success = true, message = $"Service {name} restarted" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
